<template>
  <div id="app">
    <h2 class="page-main-title">ğŸ·ï¸ íƒœê·¸ ë²ˆí˜¸ ìƒì„¸ ì¡°íšŒ ë° ìœ íš¨ì„± ê²€ì‚¬</h2>

    <div class="main-content-wrapper">
      <div class="panel api-pubdata-panel">
        <h3 class="panel-title">Tag No. Pub/Wrk ë°ì´í„° ì¡°íšŒ</h3>

        <div class="input-group">
          <label for="tagNoInputApi">ì¡°íšŒí•  Tag No. ì…ë ¥:</label>
          <input
            id="tagNoInputApi"
            v-model="tagNoForApi"
            type="text"
            placeholder="ì˜ˆ: CheckTest009"
            @keyup.enter="searchTag"
          />
        </div>
        <div class="input-group">
          <label for="projectNoInputApi">í”„ë¡œì íŠ¸ ë²ˆí˜¸:</label>
          <input id="projectNoInputApi" v-model="projectNoInput" type="text" placeholder="ì˜ˆ: TE1002" />
        </div>
        <button @click="searchTag" :disabled="apiLoading" class="action-btn primary-btn">API ìƒì„¸ ì¡°íšŒ</button>

        <div v-if="apiLoading" class="message loading-message">API ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        <div v-else-if="apiErrorMessage" class="message error-message">ì˜¤ë¥˜ ë°œìƒ: {{ apiErrorMessage }}</div>

        <div
          v-else-if="
            apiSearched &&
            !pubData &&
            (!wrkData || wrkData.length === 0) &&
            (!registerTypeData || registerTypeData.length === 0)
          "
          class="message no-results-message"
        >
          ì…ë ¥í•˜ì‹  Tag No. ({{ apiSearchedTagNo }}) ì— ëŒ€í•œ API ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>

        <div
          v-else-if="pubData || (wrkData && wrkData.length > 0) || (registerTypeData && registerTypeData.length > 0)"
        >
          <div class="results-card" v-if="pubData">
            <h4>âœ¨ Pub ë°ì´í„° ê²€ìƒ‰ ê²°ê³¼ (ë‹¨ì¼ í•­ëª©)</h4>
            <p><strong>ì¡°íšŒ Tag No.:</strong> {{ apiSearchedTagNo }}</p>
            <p><strong>EP_ID:</strong> {{ pubData.EP_ID }}</p>
            <p><strong>EP_IC:</strong> {{ pubData.EP_IC }}</p>
            <p><strong>CLS_ID:</strong> {{ pubData.CLS_ID }}</p>
            <p><strong>DELETED:</strong> {{ pubData.DELETED ? 'Yes' : 'No' }}</p>
            <p v-if="pubData.TAG_NO"><strong>ë°ì´í„° Tag No.:</strong> {{ pubData.TAG_NO }}</p>
            <p v-if="pubData.TAG_IDX"><strong>ë°ì´í„° Tag IDX.:</strong> {{ pubData.TAG_IDX }}</p>
          </div>

          <div class="results-card wrk-data-section" v-if="wrkData && wrkData.length > 0">
            <h4>âœ¨ Wrk ë°ì´í„° ê²€ìƒ‰ ê²°ê³¼ (ì—¬ëŸ¬ í•­ëª©)</h4>
            <div v-for="(wrkItem, index) in wrkData" :key="wrkItem._id || index" class="wrk-item">
              <h5>Wrk í•­ëª© #{{ index + 1 }}</h5>
              <p><strong>EP_ID:</strong> {{ wrkItem.EP_ID }}</p>
              <p><strong>EP_IC:</strong> {{ wrkItem.EP_IC }}</p>
              <p><strong>CLS_ID:</strong> {{ wrkItem.CLS_ID }}</p>
              <p><strong>TAG_IDX:</strong> {{ wrkItem.TAG_IDX }}</p>
              <p><strong>DELETED:</strong> {{ wrkItem.DELETED ? 'Yes' : 'No' }}</p>

              <div v-if="wrkItem.linkedPubData" class="linked-pub-box">
                <h6>ğŸ”— ì—°ê²°ëœ Pub ë°ì´í„° (TAG_IDX ê¸°ë°˜ ìƒì„¸)</h6>
                <p><strong>Pub EP_ID:</strong> {{ wrkItem.linkedPubData.EP_ID }}</p>
                <p><strong>Pub CLS_ID:</strong> {{ wrkItem.linkedPubData.CLS_ID }}</p>
                <p><strong>ìƒíƒœ:</strong> {{ wrkItem.linkedPubData.DELETED ? 'ì‚­ì œë¨(Deleted)' : 'ì •ìƒ(Active)' }}</p>
              </div>
              <div v-else-if="apiSearched && wrkItem.TAG_IDX" class="no-linked-pub">
                <small>ì¡°íšŒëœ ì¶”ê°€ Pub ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</small>
              </div>
            </div>
          </div>

          <div class="results-card type-id-section" v-if="registerTypeData && registerTypeData.length > 0">
            <h4>âœ¨ ê´€ë ¨ REGISTER ID ì •ë³´</h4>
            <ul>
              <li v-for="(item, index) in registerTypeData" :key="item._id || index">
                <strong>CLS_ID:</strong> {{ item.CLS_ID }} ({{ item.DESC || 'ì„¤ëª… ì—†ìŒ' }}) â†’
                <strong>REGISTER_ID:</strong> {{ item.TYPE_ID }}
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div class="panel tag-split-panel">
        <h3 class="panel-title">Tag Split (ìœ íš¨ì„± ê²€ì‚¬ê¸°)</h3>

        <div class="input-group">
          <label for="tagNoInputValidator">ê²€ì‚¬í•  Tag No. ì…ë ¥:</label>
          <input id="tagNoInputValidator" v-model="tagNoForValidator" type="text" placeholder="ì˜ˆ: AA-BBB01-0001/A" />
        </div>

        <div class="rules-table-container">
          <h4>ê·œì¹™ ì„¤ì • (ê°„ë‹¨í•œ í…Œì´ë¸”)</h4>
          <p class="panel-description">ê° íƒœê·¸ êµ¬ì„± ìš”ì†Œì˜ êµ¬ë¶„ìì™€ ì •ê·œì‹ì„ ì§ì ‘ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          <table>
            <thead>
              <tr>
                <th>TAG ID</th>
                <th>êµ¬ë¶„ì</th>
                <th>ì •ê·œì‹</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(rule, index) in tagRules" :key="index">
                <td>TAG{{ String(index + 1).padStart(3, '0') }}</td>
                <td><input type="text" v-model="rule.delimiter" maxlength="1" /></td>
                <td><input type="text" v-model="rule.regex" /></td>
                <td><button @click="removeRule(index)" class="action-btn danger-btn">ì‚­ì œ</button></td>
              </tr>
            </tbody>
          </table>
          <div class="table-actions">
            <button @click="addRule" class="action-btn success-btn">ê·œì¹™ ì¶”ê°€</button>
            <button @click="showPasteModal = true" class="action-btn info-btn">ì—‘ì…€ì—ì„œ ë¶™ì—¬ë„£ê¸°</button>
          </div>
        </div>

        <h4 class="section-sub-title">ì „ì²´ íƒœê·¸ ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬</h4>
        <div class="overall-validation-result">
          <p class="validation-summary">
            ì „ì²´ íƒœê·¸ ë²ˆí˜¸ (`{{ tagNoForValidator }}`)ëŠ” **
            <span :style="{ color: isTagNoValid ? 'green' : 'red', fontWeight: 'bold' }">
              {{ isTagNoValid ? 'ìœ íš¨í•©ë‹ˆë‹¤.' : 'ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' }}
            </span>
            **
          </p>
          <p class="regex-info">
            ì ìš©ëœ ì „ì²´ ì •ê·œì‹: <code class="combined-regex-code">{{ combinedRegexString }}</code>
          </p>
        </div>

        <h4 class="section-sub-title">ë¶€ë¶„ë³„ ë¶„ì„ ê²°ê³¼</h4>
        <table class="parts-analysis-table">
          <thead>
            <tr>
              <th>ê·œì¹™</th>
              <th>ë¶„ë¦¬ëœ ê°’</th>
              <th>ì¢…í•© ìœ íš¨ì„±</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(part, index) in tagParts" :key="index">
              <td>TAG{{ String(index + 1).padStart(3, '0') }}</td>
              <td>{{ part.matchedValue || '(ê°’ ì—†ìŒ)' }}</td>
              <td :style="{ color: part.isValid ? 'green' : 'red', fontWeight: 'bold' }">
                {{ part.isValid ? 'ìœ íš¨' : 'ìœ íš¨í•˜ì§€ ì•ŠìŒ' }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div v-if="showPasteModal" class="modal-overlay">
      <div class="modal-content">
        <h4>ì—‘ì…€ ë°ì´í„° ë¶™ì—¬ë„£ê¸°</h4>
        <p>ì—‘ì…€ì—ì„œ ë³µì‚¬í•œ ë°ì´í„°ë¥¼ ì•„ë˜ í…ìŠ¤íŠ¸ ì˜ì—­ì— ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.</p>
        <textarea
          v-model="pasteData"
          placeholder="êµ¬ë¶„ì[íƒ­]ì •ê·œì‹ í˜•íƒœ"
          rows="10"
          class="paste-textarea"
        ></textarea>
        <div class="modal-actions">
          <button @click="applyPasteData" class="action-btn success-btn">ì ìš©</button>
          <button @click="showPasteModal = false" class="action-btn cancel-btn">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, computed } from 'vue'
import { axiosWrapper } from '@/utils/axios/axios-wrapper'

export default {
  setup() {
    // --- API ì¡°íšŒ ê´€ë ¨ ìƒíƒœ ---
    const tagNoForApi = ref('')
    const projectNoInput = ref('TE1002')
    const apiSearchedTagNo = ref('')
    const pubData = ref(null)
    const wrkData = ref([])
    const registerTypeData = ref([])
    const apiLoading = ref(false)
    const apiErrorMessage = ref('')
    const apiSearched = ref(false)

    // --- Validator ê´€ë ¨ ìƒíƒœ ---
    const tagNoForValidator = ref('AP330X01-')
    const tagRules = ref([
      { delimiter: '', regex: '^$|^[A-Z]{2}$' },
      { delimiter: '', regex: '^[0123LCRIT]{3}$' },
      { delimiter: '', regex: '^[ABCDEFNVXS]{1}$' },
      { delimiter: '', regex: '^$|^[ABCDEFNVXS]{1}$' },
      { delimiter: '', regex: '^[0-9]{2}$' },
      { delimiter: '-', regex: '^$|^[APS1-9]{2}$' },
    ])
    const showPasteModal = ref(false)
    const pasteData = ref('')

    // --- API ìƒì„¸ ì¡°íšŒ ë¡œì§ (GetPubWrkDataByTagNo + GetPubDataByID) ---
    const searchTag = async () => {
      pubData.value = null
      wrkData.value = []
      registerTypeData.value = []
      apiErrorMessage.value = ''
      apiSearched.value = true

      if (!projectNoInput.value || !tagNoForApi.value) {
        apiErrorMessage.value = 'í”„ë¡œì íŠ¸ ë²ˆí˜¸ì™€ Tag No.ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'
        return
      }

      apiLoading.value = true
      apiSearchedTagNo.value = tagNoForApi.value

      try {
        // 1. ê¸°ë³¸ ë°ì´í„°(Pub & Wrk) ì¡°íšŒ
        const primaryApiUrl = '/api/Data/GetPubWrkDataByTagNo'
        const primaryPayload = {
          ProjectNo: projectNoInput.value,
          TAG_NO: tagNoForApi.value,
          ContainDeleted: true,
        }
        const primaryData = await axiosWrapper.post(primaryApiUrl, primaryPayload)

        if (primaryData) {
          pubData.value = primaryData.PubData && primaryData.PubData.length > 0 ? primaryData.PubData[0] : null
          wrkData.value = primaryData.WrkData || []

          // 2. â­ WrkDataì˜ ê° TAG_IDXë¡œ Pub ë°ì´í„° ìƒì„¸ ì¡°íšŒ (ì¶”ê°€ ë¡œì§) â­
          if (wrkData.value.length > 0) {
            const detailRequests = wrkData.value.map(async (item) => {
              if (item.TAG_IDX) {
                try {
                  const detailUrl = '/api/Data/GetPubDataByID'
                  const detailPayload = { ProjectNo: projectNoInput.value, TAG_IDX: item.TAG_IDX }
                  const detailRes = await axiosWrapper.post(detailUrl, detailPayload)
                  if (detailRes && detailRes.length > 0) {
                    item.linkedPubData = detailRes[0] // í•­ëª©ë³„ ë§¤ì¹­ ë°ì´í„° ì €ì¥
                  }
                } catch (err) {
                  console.error(`TAG_IDX ${item.TAG_IDX} ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:`, err)
                }
              }
            })
            await Promise.all(detailRequests)
          }

          // 3. CLS_ID ê¸°ë°˜ Register ID ì •ë³´ ì¡°íšŒ
          const classIDsToFetch = new Set()
          if (pubData.value?.CLS_ID) classIDsToFetch.add(pubData.value.CLS_ID)
          wrkData.value.forEach(item => { if (item.CLS_ID) classIDsToFetch.add(item.CLS_ID) })

          if (classIDsToFetch.size > 0) {
            const secondaryApiUrl = '/api/Register/GetByClassIDs'
            const secondaryPayload = {
              ProjectNo: projectNoInput.value,
              ClassIDs: Array.from(classIDsToFetch),
              ContainDeleted: true,
            }
            const secondaryResponse = await axiosWrapper.post(secondaryApiUrl, secondaryPayload)
            registerTypeData.value = secondaryResponse || []
          }
        }
      } catch (error) {
        apiErrorMessage.value = `í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`
      } finally {
        apiLoading.value = false
      }
    }

    // --- ìœ íš¨ì„± ê²€ì‚¬ ê´€ë ¨ í—¬í¼/ê³„ì‚° í•¨ìˆ˜ ---
    const isRegexOptional = regexPattern => {
      const trimmed = regexPattern.trim()
      if (!trimmed || trimmed === '^$') return true
      if (trimmed.startsWith('^$|')) return true
      try {
        return new RegExp(`^${trimmed.replace(/^\^/, '').replace(/\$$/, '')}$`).test('')
      } catch (e) { return false }
    }

    const combinedRegexString = computed(() => {
      if (tagRules.value.length === 0) return '^$'
      let regexParts = []
      tagRules.value.forEach((rule, index) => {
        let pattern = rule.regex.trim().replace(/^\^/, '').replace(/\$$/, '')
        let segment = `(?:${pattern})`
        if (index > 0 && rule.delimiter.trim() !== '') {
          const escDelim = rule.delimiter.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
          segment = isRegexOptional(rule.regex) ? `(?:${escDelim}${segment})?` : `(?:${escDelim}${segment})`
        }
        regexParts.push(segment)
      })
      return `^${regexParts.join('')}$`
    })

    const isTagNoValid = computed(() => {
      try { return new RegExp(combinedRegexString.value).test(tagNoForValidator.value) }
      catch (e) { return false }
    })

    const tagParts = computed(() => {
      const parts = []
      let currentTagNo = tagNoForValidator.value || ''
      let currentIndex = 0
      for (let i = 0; i < tagRules.value.length; i++) {
        const rule = tagRules.value[i]
        const rawRegex = rule.regex.trim().replace(/^\^/, '').replace(/\$$/, '')
        const match = new RegExp(`^(${rawRegex})`).exec(currentTagNo.substring(currentIndex))
        let matchedValue = match ? match[1] : null
        if (matchedValue !== null) currentIndex += matchedValue.length
        parts.push({ matchedValue, isValid: true })
      }
      return parts
    })

    const addRule = () => { tagRules.value.push({ delimiter: '', regex: '' }) }
    const removeRule = index => { tagRules.value.splice(index, 1) }
    const applyPasteData = () => {
      const rows = pasteData.value.trim().split('\n')
      const newRules = rows.map(row => {
        const cols = row.split('\t')
        return { delimiter: cols[0]?.trim() || '', regex: cols[1]?.trim() || cols[0]?.trim() || '' }
      }).filter(r => r.regex)
      if (newRules.length > 0) tagRules.value = newRules
      showPasteModal.value = false
    }

    return {
      tagNoForApi, projectNoInput, apiSearchedTagNo, pubData, wrkData, registerTypeData,
      apiLoading, apiErrorMessage, apiSearched, searchTag,
      tagNoForValidator, tagRules, showPasteModal, pasteData, isTagNoValid, tagParts,
      addRule, removeRule, applyPasteData, combinedRegexString
    }
  }
}
</script>

<style scoped>
#app {
  font-family: 'Segoe UI', sans-serif;
  max-width: 1400px;
  margin: 30px auto;
  padding: 30px;
  background-color: #f8f9fa;
  border-radius: 12px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.08);
}

.page-main-title {
  text-align: center;
  color: #2c3e50;
  border-bottom: 3px solid #4caf50;
  padding-bottom: 15px;
  margin-bottom: 40px;
}

.main-content-wrapper {
  display: flex;
  gap: 30px;
  flex-wrap: wrap;
}

.panel {
  flex: 1;
  min-width: 450px;
  background: white;
  padding: 30px;
  border-radius: 10px;
  border: 1px solid #dcdcdc;
  max-height: 85vh;
  overflow-y: auto;
}

.panel-title {
  font-size: 1.8em;
  border-bottom: 2px solid #5cb85c;
  padding-bottom: 10px;
  margin-bottom: 25px;
}

.input-group { margin-bottom: 20px; }
.input-group label { display: block; margin-bottom: 8px; font-weight: bold; }
.input-group input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }

.action-btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
.primary-btn { background: #007bff; color: white; }
.success-btn { background: #28a745; color: white; margin-bottom: 5px; }
.info-btn { background: #17a2b8; color: white; }
.danger-btn { background: #dc3545; color: white; padding: 5px 10px; width: auto; }
.cancel-btn { background: #6c757d; color: white; }

.message { padding: 15px; border-radius: 6px; margin-top: 20px; text-align: center; }
.loading-message { background: #e0f7fa; color: #00796b; }
.error-message { background: #ffebee; color: #d32f2f; }
.no-results-message { background: #fffde7; color: #fbc02d; }

.results-card { background: #e8f5e9; padding: 20px; border-radius: 8px; margin-top: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.results-card h4 { color: #2e7d32; border-bottom: 1px solid #c8e6c9; padding-bottom: 10px; }
.wrk-item { border-bottom: 1px solid #eee; padding: 15px 0; }
.wrk-item:last-child { border-bottom: none; }

/* â­ ì¶”ê°€ëœ ì—°ë™ Pub ë°ì´í„° ë°•ìŠ¤ ìŠ¤íƒ€ì¼ â­ */
.linked-pub-box {
  margin-top: 10px;
  padding: 12px;
  background-color: #e3f2fd;
  border-left: 5px solid #2196f3;
  border-radius: 4px;
}
.linked-pub-box h6 { margin: 0 0 8px 0; color: #0d47a1; font-size: 1em; }
.linked-pub-box p { margin: 3px 0; font-size: 0.9em; }
.no-linked-pub { color: #999; font-style: italic; margin-top: 8px; }

.rules-table-container table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.rules-table-container th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
.rules-table-container th { background: #f2f2f2; }

.overall-validation-result { padding: 15px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; margin-top: 20px; }
.combined-regex-code { background: #eee; padding: 2px 5px; border-radius: 3px; font-size: 0.9em; }

.parts-analysis-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
.parts-analysis-table th { background: #f2f2f2; }

.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;
}
.modal-content { background: white; padding: 30px; border-radius: 10px; width: 500px; }
.paste-textarea { width: 100%; margin-top: 10px; padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
.modal-actions { margin-top: 15px; display: flex; gap: 10px; }
</style>
