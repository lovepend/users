<template>
  <div class="panel mb-0">
    <div class="panel-heading border-bottom h-50px" style="background-color: var(--bg07)">
      <span class="fs-2 fw-bold" style="color: var(--basic02)">{{ $t('ReleasedNote_vue.title') }}</span>
    </div>
    <div v-if="userInfo.IsDeveloper" class="h-35px p-0 m-0" style="background-color: var(--bg11); padding: 8px 8px 6px">
      <input
        id="selectedFile"
        class="d-none"
        type="file"
        accept=".xlsx, .xls"
        @change="handleFileUpload($event)"
        ref="fileInput"
      />
      <button class="btn btn-xs btn-success float-end align-items-center shadow-none me-2 mt-1" @click="saveChangesToServer">
        변경사항 저장
      </button>
      <button class="btn btn-xs btn-gray float-end align-items-center shadow-none me-2 mt-1" @click="importExcel">
        {{ $t('ReleasedNote_vue.import') }}
      </button>
      <button class="btn btn-xs btn-primary float-end align-items-center shadow-none me-2 mt-1" @click="ExportExcel">
        버전다운
      </button>
    </div>
    <div class="panel-body py-2 overflow-auto" style="height: calc(100vh - 150px); background-color: var(--bg14)">
      <div class="pt-2 ps-3">
        <template v-if="releaseNotesGrouped.length > 0">
          <div v-for="(versionGroup, groupIndex) in releaseNotesGrouped" :key="groupIndex">
            <span class="fs-3" style="color: var(--txt04)">{{ $t('ReleasedNote_vue.version') }}</span>
            <span class="fs-3 ms-1" style="color: var(--txt04)">{{ versionGroup.version }}</span>
            <span class="fs-5 ps-2" style="color: var(--txt02)">{{ $t('ReleasedNote_vue.update') }}...</span>
            <ul class="pt-2">
              <li v-for="(item, itemIndex) in versionGroup.items" :key="itemIndex">
                <div class="fs-13px me-3">
                  <div class="h-auto mb-1 pt-1 text-white" :class="getBadgeClass(item.category)">
                    {{ item.category }}
                  </div>
                  
                  <div class="border rounded-3 mb-1 p-2" style="background-color: var(--basic02)">
                    <div class="p-1 pb-1 fw-bold" :class="getBadgeTextColorClass(item.category)">
                      [{{ item.AutoNo }}] : [{{ item.status }}]
                    </div>
                    
                    <div class="mb-2">
                      <label class="text-muted small ps-1">기능 상세 내용</label>
                      <textarea v-model="item.description" class="form-control edit-area" rows="2"></textarea>
                    </div>

                    <div class="mb-2">
                      <label class="text-cyan-700 small ps-1">{{ $t('ReleasedNote_vue.act_desc') }}</label>
                      <textarea v-model="item.actionDesc" class="form-control edit-area" rows="2"></textarea>
                    </div>

                    <div>
                      <label class="text-green-600 small ps-1">{{ $t('ReleasedNote_vue.dev_desc') }}</label>
                      <textarea v-model="item.remarkDev" class="form-control edit-area" rows="2"></textarea>
                    </div>
                  </div>
                </div>
              </li>
            </ul>
            <hr v-if="Number(groupIndex) < releaseNotesGrouped.length - 1" />
          </div>
        </template>
        <template v-else>
          <p v-if="isLoading">{{ $t('ReleasedNote_vue.load_desc') }}</p>
          <p v-else>{{ $t('ReleasedNote_vue.empt_desc') }}</p>
        </template>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
  import { ref, onMounted } from 'vue'
  import { useRoute } from 'vue-router'
  import { useAppAuthenticationStore } from '@/stores/app-authentication'
  import { axiosWrapper } from '@/utils/axios/axios-wrapper'
  import * as XLSX from 'xlsx'
  import { ApiCommon } from '@/utils/axios/api-common'
  import * as SEF from '@/utils/spread/spread-excel-funtions.js'

  const route = useRoute()
  const releaseNotesGrouped: any = ref([])
  const originalRawData: any = ref([]) // 엑셀 원본 JSON 보관용
  const isLoading = ref(true)
  const appAuthentication = useAppAuthenticationStore()
  const { userInfo } = appAuthentication
  const fileInput: any = ref(null)
  const fileId: any = ref(null)
  const urlList = {
    gfi: '/api/File/Get',
    gfr: '/api/File/Replace',
  }

  onMounted(() => {
    const baseSiteName = import.meta.env.VITE_BASE_SITENAME
    if (baseSiteName == 'dev') fileId.value = '69827ed36514d58f04e067e7'
    else if (baseSiteName == 'devop') fileId.value = '698963e8ed2aff6e2771b20d'
    else fileId.value = '6982ac8ea605319e04771832'

    fetchAndParseExcel()
  })

  /** 1. 서버 저장 로직: 화면의 데이터를 다시 엑셀로 만들어 업로드 */
  const saveChangesToServer = async function () {
    try {
      SEF.onShowOverlay()
      
      // 화면에서 수정한 내용을 원본 데이터(originalRawData)에 매핑
      releaseNotesGrouped.value.forEach((group: any) => {
        group.items.forEach((item: any) => {
          const row = item.originalRowRef
          // 필드명 보존을 위해 원본 참조 객체 업데이트
          const descKey = row['기능 요청 상세 내용'] !== undefined ? '기능 요청 상세 내용' : '__EMPTY_10'
          const actKey = row['ACTION 부서 회신 내용'] !== undefined ? 'ACTION 부서 회신 내용' : '__EMPTY_11'
          const devKey = row['Remark(개발)'] !== undefined ? 'Remark(개발)' : '__EMPTY_12'
          
          row[descKey] = item.description
          row[actKey] = item.actionDesc
          row[devKey] = item.remarkDev
        })
      });

      // XLSX를 이용해 다시 바이너리 파일로 변환
      const newSheet = XLSX.utils.json_to_sheet(originalRawData.value)
      const newWorkbook = XLSX.utils.book_new()
      XLSX.utils.book_append_sheet(newWorkbook, newSheet, "Sheet1")
      
      const excelBuffer = XLSX.write(newWorkbook, { bookType: 'xlsx', type: 'array' })
      const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' })
      const file = new File([blob], "Updated_ReleaseNote.xlsx")

      // 서버의 Replace API 호출
      const setParams: any = { id: fileId.value, File: file }
      const options = { headers: { 'Content-Type': 'multipart/form-data', FileToken: 'frontserver@sh' } }

      await axiosWrapper.post(urlList.gfr, setParams, options).then(() => {
        SEF.setToast('서버 저장 완료!', 'info')
        fetchAndParseExcel() // 데이터 새로고침
      })
    } catch (err) {
      SEF.logMng("저장 실패: ", err, 'err')
    } finally {
      SEF.onHideOverlay()
    }
  }

  const fetchAndParseExcel = async function () {
    isLoading.value = true
    try {
      const options = { responseType: 'blob', headers: { FileToken: 'frontserver@sh' } }
      await axiosWrapper.postAll(urlList.gfi, { id: fileId.value }, options).then((blobData: any) => {
        const file = new File([blobData.data], "temp.xlsx", { type: blobData.type })
        ApiCommon.postFileDecryptFile({ FILE: file }).then(async (blob: any) => {
          const data = await blob.arrayBuffer()
          const workbook = XLSX.read(data, { type: 'array' })
          const jsonData: any = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: '' })
          
          originalRawData.value = jsonData // 원본 보관
          const grouped: any = {}

          jsonData.forEach((row: any) => {
            const verRaw = row['완료 버젼'] || row['__EMPTY_18']
            if (!verRaw) return
            const version = verRaw.toString().toLowerCase()

            if (!grouped[version]) grouped[version] = { version, items: [] }
            
            grouped[version].items.push({
              originalRowRef: row, // 저장 시 참조할 원본 데이터
              AutoNo: row['Auto No'] || row['__EMPTY_4'] || '',
              category: (row['구분'] || row['__EMPTY_9'] || 'unknown').toLowerCase(),
              description: row['기능 요청 상세 내용'] || row['__EMPTY_10'] || '',
              actionDesc: row['ACTION 부서 회신 내용'] || row['__EMPTY_11'] || '',
              remarkDev: row['Remark(개발)'] || row['__EMPTY_12'] || '',
              status: row['STATUS'] || row['__EMPTY_16'] || ''
            })
          })

          releaseNotesGrouped.value = Object.values(grouped).sort((a: any, b: any) => b.version.localeCompare(a.version))
        })
      })
    } catch (error) {
      releaseNotesGrouped.value = []
    } finally {
      isLoading.value = false
      SEF.onHideOverlay()
    }
  }

  const ExportExcel = async function () {
    if (!fileId.value) return
    try {
      const options = { responseType: 'blob', headers: { FileToken: 'frontserver@sh' } }
      await axiosWrapper.postAll(urlList.gfi, { id: fileId.value }, options).then((blobData: any) => {
        const url = window.URL.createObjectURL(new Blob([blobData.data]))
        const link = document.createElement('a')
        link.href = url
        link.setAttribute('download', 'ReleasedNote.xlsx')
        document.body.appendChild(link)
        link.click()
        document.body.removeChild(link)
      })
    } catch (e) { SEF.setToast('다운로드 실패', 'err') }
  }

  const handleFileUpload = async (event: any) => {
    const file = event.target.files[0]
    const setParams: any = { id: fileId.value, File: file }
    const options = { headers: { 'Content-Type': 'multipart/form-data', FileToken: 'frontserver@sh' } }
    await axiosWrapper.post(urlList.gfr, setParams, options).then(() => fetchAndParseExcel())
  }

  const importExcel = () => fileInput.value.click()
  const getBadgeClass = (category: any) => {
    if (['오류', 'fixed'].includes(category)) return 'badge bg-gradient-orange-red'
    if (['기능개선', 'changed'].includes(category)) return 'badge bg-gradient-yellow-orange'
    if (['신규기능', 'added'].includes(category)) return 'badge bg-gradient-teal-green'
    return 'badge'
  }
  const getBadgeTextColorClass = (category: any) => {
    if (['오류', 'fixed'].includes(category)) return 'text-danger'
    if (['기능개선', 'changed'].includes(category)) return 'text-warning'
    if (['신규기능', 'added'].includes(category)) return 'text-success'
    return 'text-gray'
  }
</script>

<style scoped>
  .edit-area {
    font-size: 13px;
    background-color: #ffffff !important;
    border: 1px solid #ced4da !important;
    color: #333 !important;
    padding: 5px 8px;
    margin-top: 2px;
  }
  .edit-area:focus {
    border-color: #80bdff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }
  .badge {
    border-radius: 20px;
    display: inline-block;
    width: 80px;
    height: 30px;
    line-height: 20px;
    margin-right: 10px;
    text-transform: uppercase;
    font-size: 13px;
    font-weight: 700;
    text-align: center;
    padding-top: 5px;
  }
  ul { list-style: none; padding-left: 0; }
  li { margin: 15px 0 15px 10px; }
</style>
