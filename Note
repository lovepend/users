// 1. insertRows 함수를 먼저 정의 (참조 오류 방지)
const insertRows = function (rowCount) {
  const grid = gridRef.value;
  if (!grid) return; // 그리드 참조 확인

  grid.stopEditing();
  grid.setGridOption('loading', true);

  const filterModel = grid.getFilterModel();
  const filterDefaults = {};

  // 값을 깊숙이 찾아내고 대문자로 변환하는 함수
  const findValueAnywhere = (obj) => {
    if (!obj || typeof obj !== 'object') return null;

    let result = null;

    // 1. "filter" 키 확인
    if (obj.filter !== undefined) {
      result = obj.filter;
    }
    // 2. "values" 배열 확인 (Set Filter)
    else if (Array.isArray(obj.values) && obj.values.length > 0) {
      result = obj.values[0];
    }
    // 3. "filterModels" 배열 확인 (Multi Filter)
    else if (Array.isArray(obj.filterModels)) {
      for (const subModel of obj.filterModels) {
        const val = findValueAnywhere(subModel);
        if (val !== null) { result = val; break; }
      }
    }
    // 4. "conditions" 배열 확인
    else if (Array.isArray(obj.conditions)) {
      for (const cond of obj.conditions) {
        const val = findValueAnywhere(cond);
        if (val !== null) { result = val; break; }
      }
    }
    // 5. 기타 조건 (condition1, value 등)
    else {
      const otherVal = obj.condition1 ? findValueAnywhere(obj.condition1) :
                       obj.value !== undefined ? obj.value :
                       obj.filterFrom !== undefined ? obj.filterFrom :
                       obj.dateFrom !== undefined ? obj.dateFrom : null;
      result = otherVal;
    }

    // 문자열인 경우 대문자로 변환하여 반환
    if (result !== null && typeof result === 'string') {
      return result.toUpperCase();
    }
    return result;
  };

  // 모든 필터 컬럼 순회
  Object.keys(filterModel).forEach((colId) => {
    const val = findValueAnywhere(filterModel[colId]);
    if (val !== null && val !== undefined) {
      filterDefaults[colId] = val;
    }
  });

  const addRows = [];
  const count = parseInt(rowCount) || 1; // rowCount가 없을 경우 대비

  for (let i = 0; i < count; i++) {
    const newId = `new_${Math.random().toString(36).substring(2, 12)}`;
    const newRow = {
      STATUS: 'A',
      PROJ_NO: currentProjNo.value,
      ATT_ID: null,
      CL_ID: null,
      VAL_TYPE: VAL_TYPES.STRING.VALUE,
      RDON_YN: false,
      IGN_LIST_VAL: false,
      CRTER_NO: userInfo.value?.UserID,
      _id: newId,
      ...filterDefaults // 필터링된 대문자 값 주입
    };
    addRows.push(newRow);
  }

  if (addRows.length > 0) {
    const lastIndex = grid.getDisplayedRowCount();
    const result = grid.applyTransaction({ add: addRows, addIndex: lastIndex });
    
    grid.refreshCells({ force: true, suppressFlash: true });
    grid.setNodesSelected({ nodes: result.add, newValue: true });
    grid.ensureIndexVisible(lastIndex, 'bottom');
  }
  grid.setGridOption('loading', false);
};

// 2. 버튼 클릭 핸들러들
const onCreateRows = function () {
  if (!currentProjNo.value) {
    sAlert.Warning(`Project를 선택해주세요`);
    return;
  }
  insertRows(1);
};

const onCreateMultiRows = function (rowCount) {
  if (!currentProjNo.value) {
    sAlert.Warning(`Project를 선택해주세요`);
    return;
  }
  // 전달받은 rowCount가 이벤트 객체인 경우를 대비해 처리
  const count = typeof rowCount === 'number' ? rowCount : 1;
  insertRows(count);
};
