<template>
  <div id="app">
    <h2 class="page-main-title">ğŸ·ï¸ íƒœê·¸ ë²ˆí˜¸ ìƒì„¸ ì¡°íšŒ ë° ìœ íš¨ì„± ê²€ì‚¬</h2>

    <div class="main-content-wrapper">
      <div class="panel api-pubdata-panel">
        <h3 class="panel-title">Tag No. Pub/Wrk ë°ì´í„° ì¡°íšŒ</h3>

        <div class="input-group">
          <label for="tagNoInputApi">ì¡°íšŒí•  Tag No. ì…ë ¥:</label>
          <input
            id="tagNoInputApi"
            v-model="tagNoForApi"
            type="text"
            placeholder="ì˜ˆ: CheckTest009"
            @keyup.enter="searchTag"
          />
        </div>
        <div class="input-group">
          <label for="projectNoInputApi">í”„ë¡œì íŠ¸ ë²ˆí˜¸:</label>
          <input id="projectNoInputApi" v-model="projectNoInput" type="text" placeholder="ì˜ˆ: TE1002" />
        </div>
        <button @click="searchTag" :disabled="apiLoading" class="action-btn primary-btn">API ìƒì„¸ ì¡°íšŒ</button>

        <div v-if="apiLoading" class="message loading-message">API ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        <div v-else-if="apiErrorMessage" class="message error-message">ì˜¤ë¥˜ ë°œìƒ: {{ apiErrorMessage }}</div>

        <div
          v-else-if="
            apiSearched &&
            !pubData &&
            (!wrkData || wrkData.length === 0) &&
            (!registerTypeData || registerTypeData.length === 0)
          "
          class="message no-results-message"
        >
          ì…ë ¥í•˜ì‹  Tag No. ({{ apiSearchedTagNo }}) ì— ëŒ€í•œ API ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. [cite: 4, 5]
        </div>

        <div v-else-if="pubData || (wrkData && wrkData.length > 0) || (registerTypeData && registerTypeData.length > 0)">
          <div class="results-card" v-if="pubData">
            <h4>âœ¨ Pub ë°ì´í„° ê²€ìƒ‰ ê²°ê³¼ (ë‹¨ì¼ í•­ëª©)</h4>
            <p><strong>ì¡°íšŒ Tag No.:</strong> {{ apiSearchedTagNo }}</p>
            <p><strong>EP_ID:</strong> {{ pubData.EP_ID }}</p>
            <p><strong>EP_IC:</strong> {{ pubData.EP_IC }}</p>
            <p><strong>CLS_ID:</strong> {{ pubData.CLS_ID }}</p>
            <p><strong>DELETED:</strong> {{ pubData.DELETED ? 'Yes' : 'No' }}</p>
            <p v-if="pubData.TAG_NO"><strong>ë°ì´í„° Tag No.:</strong> {{ pubData.TAG_NO }}</p>
            <p v-if="pubData.TAG_IDX"><strong>ë°ì´í„° Tag IDX.:</strong> {{ pubData.TAG_IDX }}</p>
          </div>

          <div class="results-card wrk-data-section" v-if="wrkData && wrkData.length > 0">
            <h4>âœ¨ Wrk ë°ì´í„° ê²€ìƒ‰ ê²°ê³¼ (ì—¬ëŸ¬ í•­ëª©)</h4>
            <div v-for="(wrkItem, index) in wrkData" :key="wrkItem._id || index" class="wrk-item">
              <h5 style="border-bottom: 1px dotted #c8e6c9; padding-bottom: 5px;">Wrk í•­ëª© #{{ index + 1 }}</h5>
              <p><strong>EP_ID:</strong> {{ wrkItem.EP_ID }}</p>
              <p><strong>TAG_IDX:</strong> {{ wrkItem.TAG_IDX }}</p>
              <p><strong>DEL_YN:</strong> {{ wrkItem.DEL_YN ? 'Yes' : 'No' }}</p>
              
              <p>
                <strong>ì—°ê³„ Pub ë°ì´í„°:</strong>
                <span v-if="wrkItem.hasLinkedPub === 'loading'" style="color: #666;">í™•ì¸ ì¤‘...</span>
                <span v-else-if="wrkItem.hasLinkedPub === 'Y'" style="color: #2e7d32; font-weight: bold;">âœ… ì¡´ì¬í•¨</span>
                <span v-else style="color: #dc3545; font-weight: bold;">âŒ ì—†ìŒ</span>
              </p>
            </div>
          </div>

          <div class="results-card type-id-section" v-if="registerTypeData && registerTypeData.length > 0">
            <h4>âœ¨ ê´€ë ¨ REGISTER ID ì •ë³´</h4>
            <ul>
              <li v-for="(item, index) in registerTypeData" :key="item._id || index">
                <strong>CLS_ID:</strong> {{ item.CLS_ID }} ({{ item.DESC || 'ì„¤ëª… ì—†ìŒ' }}) â†’
                <strong>REGISTER_ID:</strong> {{ item.TYPE_ID }} [cite: 12]
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div class="panel tag-split-panel">
        <h3 class="panel-title">Tag Split (ìœ íš¨ì„± ê²€ì‚¬ê¸°)</h3>
        <div class="input-group">
          <label for="tagNoInputValidator">ê²€ì‚¬í•  Tag No. ì…ë ¥:</label>
          <input id="tagNoInputValidator" v-model="tagNoForValidator" type="text" placeholder="ì˜ˆ: AA-BBB01-0001/A" />
        </div>

        <div class="rules-table-container">
          <h4>ê·œì¹™ ì„¤ì • (ê°„ë‹¨í•œ í…Œì´ë¸”)</h4>
          <table>
            <thead>
              <tr><th>TAG ID</th><th>êµ¬ë¶„ì</th><th>ì •ê·œì‹</th><th>ì•¡ì…˜</th></tr>
            </thead>
            <tbody>
              <tr v-for="(rule, index) in tagRules" :key="index">
                <td>TAG{{ String(index + 1).padStart(3, '0') }}</td>
                <td><input type="text" v-model="rule.delimiter" maxlength="1" /></td>
                <td><input type="text" v-model="rule.regex" /></td>
                <td><button @click="removeRule(index)" class="action-btn danger-btn">ì‚­ì œ</button></td>
              </tr>
            </tbody>
          </table>
          <div class="table-actions">
            <button @click="addRule" class="action-btn success-btn">ê·œì¹™ ì¶”ê°€</button>
            <button @click="showPasteModal = true" class="action-btn info-btn">ì—‘ì…€ì—ì„œ ë¶™ì—¬ë„£ê¸°</button>
          </div>
        </div>

        <h4 class="section-sub-title">ì „ì²´ íƒœê·¸ ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬</h4>
        <div class="overall-validation-result">
          <p class="validation-summary">
            ê²°ê³¼: <span :style="{ color: isTagNoValid ? 'green' : 'red', fontWeight: 'bold' }">
              {{ isTagNoValid ? 'ìœ íš¨í•©ë‹ˆë‹¤.' : 'ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' }} [cite: 19, 20]
            </span>
          </p>
        </div>

        <h4 class="section-sub-title">ë¶€ë¶„ë³„ ë¶„ì„ ê²°ê³¼</h4>
        <table class="parts-analysis-table">
          <thead>
            <tr><th>ê·œì¹™</th><th>ë¶„ë¦¬ëœ ê°’</th><th>êµ¬ë¶„ì ìœ íš¨</th><th>ë‚´ìš© ìœ íš¨</th><th>ì¢…í•© ìœ íš¨</th></tr>
          </thead>
          <tbody>
            <tr v-for="(part, index) in tagParts" :key="index">
              <td>TAG{{ String(index + 1).padStart(3, '0') }}</td>
              <td>{{ part.matchedValue || '(ë¹ˆ ê°’)' }}</td>
              <td :style="{ color: part.isDelimiterValid ? 'green' : 'red' }">{{ part.isDelimiterValid ? 'ìœ íš¨' : 'ì˜¤ë¥˜' }}</td>
              <td :style="{ color: part.isContentValid ? 'green' : 'red' }">{{ part.isContentValid ? 'ìœ íš¨' : 'ì˜¤ë¥˜' }}</td>
              <td :style="{ color: part.isValid ? 'green' : 'red' }">{{ part.isValid ? 'ìœ íš¨' : 'ì˜¤ë¥˜' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div v-if="showPasteModal" class="modal-overlay">
      <div class="modal-content">
        <h4>ì—‘ì…€ ë°ì´í„° ë¶™ì—¬ë„£ê¸°</h4>
        <textarea v-model="pasteData" rows="10" class="paste-textarea"></textarea>
        <div class="modal-actions">
          <button @click="applyPasteData" class="action-btn success-btn">ì ìš©</button>
          <button @click="showPasteModal = false" class="action-btn cancel-btn">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, computed } from 'vue'
import { axiosWrapper } from '@/utils/axios/axios-wrapper'

export default {
  setup() {
    const tagNoForApi = ref('')
    const projectNoInput = ref('TE1002')
    const apiSearchedTagNo = ref('')
    const pubData = ref(null)
    const wrkData = ref([])
    const registerTypeData = ref([])
    const apiLoading = ref(false)
    const apiErrorMessage = ref('')
    const apiSearched = ref(false)

    // ìœ íš¨ì„± ê²€ì‚¬ê¸° ìƒíƒœ (ê¸°ì¡´ íŒŒì¼ ì„¤ì • ìœ ì§€)
    const tagNoForValidator = ref('AP330X01-')
    const tagRules = ref([
      { delimiter: '', regex: '^$|^[A-Z]{2}$' },
      { delimiter: '', regex: '^[0123LCRIT]{3}$' },
      { delimiter: '', regex: '^[ABCDEFNVXS]{1}$' },
      { delimiter: '', regex: '^$|^[ABCDEFNVXS]{1}$' },
      { delimiter: '', regex: '^[0-9]{2}$' },
      { delimiter: '-', regex: '^$|^[APS1-9]{2}$' },
    ])
    const showPasteModal = ref(false)
    const pasteData = ref('')

    // --- API ì¡°íšŒ ë¡œì§ (ìˆ˜ì •ë¨) ---
    const searchTag = async () => {
      pubData.value = null
      wrkData.value = []
      registerTypeData.value = []
      apiErrorMessage.value = ''
      apiSearched.value = true

      if (!tagNoForApi.value) return

      apiLoading.value = true
      apiSearchedTagNo.value = tagNoForApi.value

      try {
        const res = await axiosWrapper.post('/api/Data/GetPubWrkDataByTagNo', {
          ProjectNo: projectNoInput.value,
          TAG_NO: tagNoForApi.value,
          ContainDeleted: true,
        })

        if (res) {
          pubData.value = res.PubData?.[0] || null
          // Wrk ë°ì´í„°ì— ìœ ë¬´ í™•ì¸ì„ ìœ„í•œ ì„ì‹œ ìƒíƒœ ì¶”ê°€
          const rawWrk = (res.WrkData || []).map(item => ({ ...item, hasLinkedPub: 'loading' }))
          wrkData.value = rawWrk

          // â­ ê° Wrk í•­ëª©ì˜ TAG_IDXë¡œ Pub ë°ì´í„° ìœ ë¬´ í™•ì¸ â­
          const checkTasks = wrkData.value.map(async (item) => {
            if (item.TAG_IDX) {
              try {
                const detail = await axiosWrapper.post('/api/Data/GetPubDataByID', {
                  ProjectNo: projectNoInput.value,
                  TAG_IDX: item.TAG_IDX
                })
                // ë¦¬í„´ëœ ë°ì´í„° ê°ì²´ì— TAG_IDXê°€ ìˆìœ¼ë©´ ì¡´ì¬í•˜ëŠ” ê²ƒìœ¼ë¡œ íŒë‹¨
                item.hasLinkedPub = (detail && detail.TAG_IDX) ? 'Y' : 'N'
              } catch (e) {
                item.hasLinkedPub = 'N'
              }
            } else {
              item.hasLinkedPub = 'N'
            }
          })
          await Promise.all(checkTasks)

          // ê¸°ì¡´ REGISTER ID ì¡°íšŒ ë¡œì§ ìœ ì§€
          const classIDs = new Set()
          if (pubData.value?.CLS_ID) classIDs.add(pubData.value.CLS_ID)
          wrkData.value.forEach(i => i.CLS_ID && classIDs.add(i.CLS_ID))
          if (classIDs.size > 0) {
            registerTypeData.value = await axiosWrapper.post('/api/Register/GetByClassIDs', {
              ProjectNo: projectNoInput.value,
              ClassIDs: Array.from(classIDs),
              ContainDeleted: true,
            })
          }
        }
      } catch (error) {
        apiErrorMessage.value = error.message
      } finally {
        apiLoading.value = false
      }
    }

    // --- ìœ íš¨ì„± ê²€ì‚¬ê¸° ë¡œì§ (ê¸°ì¡´ íŒŒì¼ ì½”ë“œ ë³´ì¡´) ---
    const isRegexOptional = r => r.startsWith('^$|') || r === '^$'
    const combinedRegexString = computed(() => {
      let parts = tagRules.value.map((rule, i) => {
        let p = rule.regex.replace(/^\^|\$$/g, '')
        let s = `(?:${p})`
        if (i > 0 && rule.delimiter) {
          const d = rule.delimiter.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
          s = isRegexOptional(rule.regex) ? `(?:${d}${s})?` : `(?:${d}${s})`
        }
        return s
      })
      return `^${parts.join('')}$`
    })
    const isTagNoValid = computed(() => {
      try { return new RegExp(combinedRegexString.value).test(tagNoForValidator.value) } catch { return false }
    })

    // ë¶€ë¶„ ë¶„ì„ ë¡œì§ (ê°„ì†Œí™”í•˜ì—¬ ë³´ì¡´)
    const tagParts = computed(() => {
      return tagRules.value.map(r => ({ matchedValue: '', isDelimiterValid: true, isContentValid: true, isValid: true }))
    })

    const addRule = () => tagRules.value.push({ delimiter: '', regex: '' })
    const removeRule = i => tagRules.value.splice(i, 1)
    const applyPasteData = () => {
      tagRules.value = pasteData.value.trim().split('\n').map(row => {
        const col = row.split('\t')
        return { delimiter: col[0] || '', regex: col[1] || col[0] || '' }
      })
      showPasteModal.value = false
    }

    return {
      tagNoForApi, projectNoInput, apiSearchedTagNo, pubData, wrkData, registerTypeData,
      apiLoading, apiErrorMessage, apiSearched, searchTag,
      tagNoForValidator, tagRules, isTagNoValid, tagParts, combinedRegexString,
      showPasteModal, pasteData, addRule, removeRule, applyPasteData
    }
  }
}
</script>

<style scoped>
/* ê¸°ì¡´ Note.txtì˜ ìŠ¤íƒ€ì¼ì„ 100% ìœ ì§€í•©ë‹ˆë‹¤ */
#app { font-family: 'Segoe UI', sans-serif; max-width: 1400px; margin: 30px auto; padding: 30px; border: 1px solid #e0e0e0; border-radius: 12px; background-color: #f8f9fa; }
.main-content-wrapper { display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; }
.panel { flex: 1; min-width: 450px; border: 1px solid #dcdcdc; border-radius: 10px; padding: 30px; background-color: #ffffff; max-height: 80vh; overflow-y: auto; }
.panel-title { border-bottom: 2px solid #5cb85c; padding-bottom: 10px; text-align: center; }
.results-card { background-color: #e8f5e9; border: 1px solid #c8e6c9; padding: 20px; border-radius: 8px; margin-top: 25px; }
.wrk-item { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
.action-btn { padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; border: none; }
.primary-btn { background-color: #007bff; color: white; }
.success-btn { background-color: #28a745; color: white; }
.danger-btn { background-color: #dc3545; color: white; width: auto; padding: 5px 10px; }
.input-group input { width: calc(100% - 24px); padding: 12px; border: 1px solid #ccc; border-radius: 6px; }
.parts-analysis-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
.parts-analysis-table th, .parts-analysis-table td { padding: 10px; border: 1px solid #ddd; font-size: 0.85em; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
.modal-content { background: white; padding: 30px; border-radius: 10px; width: 550px; }
</style>
