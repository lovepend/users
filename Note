<script>
  import { shallowRef } from 'vue'
  import { ApiCommon } from '@/utils/axios/api-common'
  import vSelect from 'vue-select'
  import { useEmployees } from '@/stores/app-employees'
  import { debounce } from 'lodash-es' // lodash-es 또는 lodash 설치 필요

  const { setEmployeeInfo } = useEmployees()

  export default {
    name: 'AgUserEditor',
    components: { vSelect },
    props: {
      params: { type: Object, default: () => ({}) },
    },
    setup(props) {
      return {
        containerRef: shallowRef(null),
        vSelectRef: shallowRef(null),
        vModelRef: shallowRef(null),
        vOptionsRef: shallowRef([]),
        vValue: shallowRef(null),
      }
    },
    mounted() {
      this.vModelRef = this.params?.editorSelected
      this.vOptionsRef = this.params?.editorOptions ?? []
      this.vValue = this.getInitialValue()
      setTimeout(() => {
        this.vSelectRef?.searchEl.focus()
      }, 1)
    },
    methods: {
      getValue() {
        return this.vValue
      },
      getInitialValue() {
        return this.params?.value
      },
      onClosePopup() {
        try {
          if (this.params) {
            this.params.stopEditing()
          }
        } catch (e) {
          // ignore
        }
      },
      setValue(USER_ID) {
        const newValue = String(USER_ID ?? '')
        this.vValue = newValue === '' ? null : newValue
      },
      getSelectedValue() {
        return this.vModelRef?.code
      },
      onKeydown(event) {
        if (event.key === 'Escape' || event.key === 'ESC') {
          event.preventDefault()
          const userId = this.getInitialValue()
          this.setValue(userId)
          this.onClosePopup()
        } else if (event.key === 'Enter') {
          event.preventDefault()
          event.stopPropagation()
          const userId = this.getSelectedValue()
          if (userId) {
            this.setValue(userId)
            this.onClosePopup()
          }
        }
      },

      /**
       * debounce를 적용하여 타이핑 중 빈번한 API 호출을 방지하고
       * 한글 조합(IME)이 완료될 시간을 확보합니다.
       */
      onSearch: debounce(async function (search, loading) {
        // 공백 제거 후 검색어 확인
        const userName = String(search ?? '').trim()
        
        // 검색어가 너무 짧으면 호출하지 않음 (한글 1자도 검색하려면 1로 수정 가능)
        if (userName.length < 1) {
          this.vOptionsRef = []
          return
        }

        try {
          loading(true)
          
          // API 호출: '박정철' 입력 시 조합이 완료된 userName이 전달됨
          const response = (await ApiCommon.postOfficeFindEmployee({ 
            Type: 'Name', 
            Keyword: userName 
          })) ?? []

          const options = response
            .filter(item => item.EMP_NO)
            .map(item => ({
              ...item,
              code: item.EMP_NO,
              label: `${item.EMP_NM ?? ''}(${item.DEPT_NAME ?? ''})`,
            }))

          // 데이터 스토어 업데이트 (불필요한 루프 제거)
          if (options.length > 0) {
            setEmployeeInfo(options)
          }

          this.vOptionsRef = options
        } catch (error) {
          console.error('Search Error:', error)
          this.vOptionsRef = []
        } finally {
          loading(false)
        }
      }, 300), // 300ms 대기 후 실행

      onSelected(item) {
        this.setValue(item?.code)
        // 선택 후 포커스를 컨테이너로 옮겨 팝업이 바로 닫히지 않도록 제어 가능
        setTimeout(() => this.containerRef?.focus(), 1)
      },
      dropdownShouldOpen(vselect) {
        return !vselect.loading && vselect.open
      },
    },
  }
</script>

<template>
  <div ref="containerRef" class="p-1 bg-white ag-user-editor-container" tabindex="0" @keydown="onKeydown">
    <div class="d-flex flex-row my-1 justify-content-between">
      <span class="badge bg-info">ESC - 취소 / Enter - 선택</span>
      <span class="badge bg-dark" style="cursor: pointer" @click="onClosePopup">X</span>
    </div>
    <vSelect
      ref="vSelectRef"
      v-model="vModelRef"
      :options="vOptionsRef"
      :taggable="false"
      :filterable="false" 
      :placeholder="'검색어 입력 (예: 박정철)'"
      :dropdown-should-open="dropdownShouldOpen"
      @option:selected="onSelected"
      @search="onSearch"
      class="w-100 ag-user-editor-select"
    >
      <template #no-options="{ searching }">
        <template v-if="searching">검색 결과가 없습니다.</template>
        <template v-else>이름을 입력해 주세요.</template>
      </template>
    </vSelect>
  </div>
</template>

<style scoped lang="scss">
  .ag-user-editor-container {
    border: 1px solid #a8beed;
    min-width: 300px;
    width: auto;
    height: auto;
    outline: none;
  }
  :deep().ag-user-editor-select {
    .vs__dropdown-toggle {
      .vs__selected-options {
        flex-wrap: wrap !important;
        .vs__search {
          color: #555;
        }
      }
    }
    &.vs--searching .vs__search {
      color: #000 !important;
    }
    .vs__dropdown-menu {
      padding: 0.5rem !important;
      border-radius: 5px;
      border: 1px solid rgb(168, 190, 237);
      background-color: #fff;
      max-height: 200px;
      overflow-x: hidden;
      .vs__dropdown-option--selected {
        background: #d9e5ff;
        color: #000000;
      }
    }
  }
</style>
