<template>
  <div id="app">
    <h2 class="page-main-title">ğŸ·ï¸ íƒœê·¸ ë²ˆí˜¸ ìƒì„¸ ì¡°íšŒ ë° ìœ íš¨ì„± ê²€ì‚¬</h2>

    <div class="main-content-wrapper">
      <div class="panel api-pubdata-panel">
        <h3 class="panel-title">Tag No. Pub/Wrk ë°ì´í„° ì¡°íšŒ</h3>

        <div class="input-group">
          <label for="tagNoInputApi">ì¡°íšŒí•  Tag No. ì…ë ¥:</label>
          <input
            id="tagNoInputApi"
            v-model="tagNoForApi"
            type="text"
            placeholder="ì˜ˆ: CheckTest009"
            @keyup.enter="searchTag"
          />
        </div>
        <div class="input-group">
          <label for="projectNoInputApi">í”„ë¡œì íŠ¸ ë²ˆí˜¸:</label>
          <input id="projectNoInputApi" v-model="projectNoInput" type="text" placeholder="ì˜ˆ: TE1002" />
        </div>
        <button @click="searchTag" :disabled="apiLoading" class="action-btn primary-btn">API ìƒì„¸ ì¡°íšŒ</button>

        <div v-if="apiLoading" class="message loading-message">API ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        <div v-else-if="apiErrorMessage" class="message error-message">ì˜¤ë¥˜ ë°œìƒ: {{ apiErrorMessage }}</div>

        <div
          v-else-if="
            apiSearched &&
            !pubData &&
            (!wrkData || wrkData.length === 0)
          "
          class="message no-results-message"
        >
          ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>

        <div v-else-if="pubData || (wrkData && wrkData.length > 0)">
          <div class="results-card" v-if="pubData">
            <h4>âœ¨ Pub ë°ì´í„° ê²°ê³¼</h4>
            <p><strong>EP_ID:</strong> {{ pubData.EP_ID }}</p>
            <p><strong>TAG_NO:</strong> {{ pubData.TAG_NO }}</p>
          </div>

          <div class="results-card wrk-data-section" v-if="wrkData && wrkData.length > 0">
            <h4>âœ¨ Wrk ë°ì´í„° ë¦¬ìŠ¤íŠ¸</h4>
            <div v-for="(wrkItem, index) in wrkData" :key="wrkItem._id || index" class="wrk-item">
              <div class="wrk-info-row">
                <h5>Wrk í•­ëª© #{{ index + 1 }}</h5>
                <p><strong>EP_ID:</strong> {{ wrkItem.EP_ID }}</p>
                <p><strong>TAG_IDX:</strong> {{ wrkItem.TAG_IDX }}</p>
                <p><strong>DEL_YN:</strong> {{ wrkItem.DEL_YN ? 'Y' : 'N' }}</p>
                
                <div class="pub-link-status" :class="{ 'has-data': wrkItem.hasLinkedPub === 'Y', 'no-data': wrkItem.hasLinkedPub === 'N' }">
                  <strong>ì—°ê³„ëœ Pub ë°ì´í„°:</strong> 
                  <span v-if="wrkItem.hasLinkedPub === 'loading'">í™•ì¸ ì¤‘...</span>
                  <span v-else-if="wrkItem.hasLinkedPub === 'Y'">âœ… ì¡´ì¬í•¨</span>
                  <span v-else-if="wrkItem.hasLinkedPub === 'N'">âŒ ì—†ìŒ</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel tag-split-panel">
        <h3 class="panel-title">Tag Split (ìœ íš¨ì„± ê²€ì‚¬ê¸°)</h3>
        <div class="input-group">
          <label for="tagNoInputValidator">ê²€ì‚¬í•  Tag No. ì…ë ¥:</label>
          <input id="tagNoInputValidator" v-model="tagNoForValidator" type="text" placeholder="ì˜ˆ: AA-BBB01-0001/A" />
        </div>
        <p>ì „ì²´ ìœ íš¨ì„±: {{ isTagNoValid ? 'ìœ íš¨' : 'ë¶ˆê°€' }}</p>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, computed } from 'vue'
import { axiosWrapper } from '@/utils/axios/axios-wrapper'

export default {
  setup() {
    const tagNoForApi = ref('')
    const projectNoInput = ref('TE1002')
    const pubData = ref(null)
    const wrkData = ref([])
    const apiLoading = ref(false)
    const apiErrorMessage = ref('')
    const apiSearched = ref(false)

    // Validator ìƒíƒœ
    const tagNoForValidator = ref('AP330X01-')
    const tagRules = ref([{ delimiter: '', regex: '^[A-Z]{2}$' }])

    // â­ í•µì‹¬: searchTag í•¨ìˆ˜ â­
    const searchTag = async () => {
      pubData.value = null
      wrkData.value = []
      apiErrorMessage.value = ''
      apiSearched.value = true
      apiLoading.value = true

      try {
        // 1. ì²« ë²ˆì§¸ API í˜¸ì¶œ (ê¸°ì¡´)
        const res = await axiosWrapper.post('/api/Data/GetPubWrkDataByTagNo', {
          ProjectNo: projectNoInput.value,
          TAG_NO: tagNoForApi.value,
          ContainDeleted: true,
        })

        if (res) {
          pubData.value = res.PubData?.[0] || null
          // Wrk ë°ì´í„°ì— 'loading' ìƒíƒœ ì£¼ì…
          const rawWrk = (res.WrkData || []).map(item => ({ ...item, hasLinkedPub: 'loading' }))
          wrkData.value = rawWrk

          // 2. ê° Wrk í•­ëª©ì— ëŒ€í•´ ê°œë³„ TAG_IDX ì¡°íšŒ (ë³‘ë ¬ ì²˜ë¦¬)
          const detailRequests = wrkData.value.map(async (item) => {
            if (item.TAG_IDX) {
              try {
                const detailRes = await axiosWrapper.post('/api/Data/GetPubDataByID', {
                  ProjectNo: projectNoInput.value,
                  TAG_IDX: item.TAG_IDX
                })
                // ë¦¬í„´ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ 'Y', ì—†ìœ¼ë©´ 'N' (ê°ì²´ ì¡´ì¬ ì—¬ë¶€ ì²´í¬)
                item.hasLinkedPub = (detailRes && detailRes.TAG_IDX) ? 'Y' : 'N'
              } catch (e) {
                console.error(e)
                item.hasLinkedPub = 'N'
              }
            } else {
              item.hasLinkedPub = 'N'
            }
          })

          await Promise.all(detailRequests)
        }
      } catch (err) {
        apiErrorMessage.value = err.message
      } finally {
        apiLoading.value = false
      }
    }

    const isTagNoValid = computed(() => {
      try { return new RegExp(tagRules.value[0].regex).test(tagNoForValidator.value) } catch { return false }
    })

    return {
      tagNoForApi, projectNoInput, pubData, wrkData, apiLoading, apiErrorMessage, apiSearched,
      searchTag, tagNoForValidator, tagRules, isTagNoValid
    }
  }
}
</script>

<style scoped>
#app { font-family: sans-serif; padding: 20px; background: #f4f7f6; }
.main-content-wrapper { display: flex; gap: 20px; }
.panel { flex: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.results-card { background: #e8f4fd; padding: 15px; border-radius: 6px; margin-top: 15px; }
.wrk-item { border-bottom: 1px solid #ddd; padding: 15px 0; }
.wrk-item:last-child { border-bottom: none; }

/* â­ ìœ ë¬´ í‘œì‹œ ìŠ¤íƒ€ì¼ â­ */
.pub-link-status {
  margin-top: 8px;
  padding: 8px;
  border-radius: 4px;
  font-size: 0.9em;
}
.pub-link-status.has-data { background-color: #e6fffa; color: #2c7a7b; border: 1px solid #b2f5ea; }
.pub-link-status.no-data { background-color: #fff5f5; color: #c53030; border: 1px solid #feb2b2; }

.action-btn { width: 100%; padding: 10px; background: #3182ce; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
.input-group { margin-bottom: 10px; }
.input-group input { width: 100%; padding: 8px; box-sizing: border-box; }
</style>
