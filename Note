<script>
  import { shallowRef } from 'vue'
  import { ApiCommon } from '@/utils/axios/api-common'
  import vSelect from 'vue-select'
  import { useEmployees } from '@/stores/app-employees'
  const { setEmployeeInfo } = useEmployees()

  export default {
    name: 'AgUserEditor',
    components: { vSelect },
    props: {
      // AG-Grid Custom Editor Params - ICellEditorParams
      // 기본 Parameters와 cellEditorParams의 추가 Parameters
      params: { type: Object, default: () => ({}) },
    },
    setup(props) {
      return {
        containerRef: shallowRef(null),
        vSelectRef: shallowRef(null),
        vModelRef: shallowRef(null),
        vOptionsRef: shallowRef([]),
        vValue: shallowRef(null),
      }
    },
    mounted() {
      this.vModelRef = this.params?.editorSelected
      this.vOptionsRef = this.params?.editorOptions ?? []
      this.vValue = this.getInitialValue()
      setTimeout(() => {
        this.vSelectRef?.searchEl.focus()
      }, 1)
    },
    methods: {
      // AG-Grid Custom Editor Functions - ICellEditor
      // getValue - 필수
      // refresh
      // afterGuiAttached
      // getPopupPosition
      // isCancelBeforeStart
      // isCancelAfterEnd
      // focusIn
      // focusOut
      // getValidationElement
      // getValidationErrors
      getValue() {
        return this.vValue
      },
      getInitialValue() {
        return this.params?.value
      },
      ///////////////////////////////////////////
      // This Component Using Functions
      onClosePopup() {
        try {
          if (this.params) {
            this.params.stopEditing()
          }
        } catch {
          let dummyVar
        }
      },
      setValue(USER_ID) {
        const newValue = String(USER_ID ?? '')
        this.vValue = newValue === '' ? null : newValue
      },
      getSelectedValue() {
        return this.vModelRef?.code
      },
      onKeydown(event) {
        if (event.key === 'ESC') {
          event.preventDefault()
          const userId = this.getInitialValue()
          this.setValue(userId)
          this.onClosePopup()
        } else if (event.key === 'Enter') {
          event.preventDefault()
          event.stopPropagation()
          const userId = this.getSelectedValue()
          if (userId) {
            this.setValue(userId)
            this.onClosePopup()
          }
        }
      },
      // vSelect Events
      async onSearch(search, loading) {
        try {
          loading(true)
          const userName = String(search ?? '').replaceAll(' ', '')
          if (userName.length < 2) {
            throw new Error(``)
          }
          const response = (await ApiCommon.postOfficeFindEmployee({ Type: 'Name', Keyword: userName })) ?? []
          const options = response
            .filter(item => item.EMP_NO) // EMP_NO가 있는 항목만 필터링
            .map(item => ({
              ...item,
              code: item.EMP_NO,
              label: `${item.EMP_NM ?? ''}(${item.DEPT_NAME ?? ''})`,
            }))
          for (let i = options?.length; i--; ) {
            setEmployeeInfo(options)
          }
          this.vOptionsRef = options
          return true
        } catch (error) {
          // console.error('API 호출 중 오류 발생:', error);
          return false
        } finally {
          loading(false)
        }
      },
      onSelected(item) {
        this.setValue(item?.code)
        setTimeout(() => this.containerRef?.focus(), 1)
        // this.onClosePopup();
      },
      dropdownShouldOpen: function (vselect) {
        return !vselect.loading && vselect.open
      },
    },
  }
</script>

<template>
  <div ref="containerRef" class="p-1 bg-white ag-user-editor-container" tabindex="0" @keydown="onKeydown">
    <div class="d-flex flex-row my-1 justify-content-between">
      <span class="badge bg-info">ESC - 취소</span>
      <span class="badge bg-dark" style="cursor: pointer" @click="onClosePopup">X</span>
    </div>
    <vSelect
      ref="vSelectRef"
      v-model="vModelRef"
      :options="vOptionsRef"
      :taggable="false"
      :filterable="false"
      :placeholder="'Name to search for. ex)홍길동 / ㅎㄱㄷ'"
      :dropdown-should-open="dropdownShouldOpen"
      @option:selected="onSelected"
      @search="onSearch"
      class="w-100 ag-user-editor-select"
    />
  </div>
</template>

<style scoped lang="scss">
  .ag-user-editor-container {
    border: 1px solid #a8beed;
    min-width: 300px;
    width: auto;
    height: auto;
    outline: none;
  }
  :deep().ag-user-editor-select {
    > .vs__dropdown-toggle {
      > .vs__selected-options {
        flex-wrap: wrap !important;
        > .vs__selected {
          margin-bottom: 2px !important;
        }
        > .vs__search {
          color: lightgray;
        }
      }
    }
    &.vs--searching {
      .vs__search {
        color: #000000 !important;
      }
    }
    > .vs__dropdown-menu {
      padding: 0.5rem !important;
      border-radius: 5px;
      border: 1px solid rgb(168, 190, 237);
      background-color: #fff;
      max-height: 200px;
      box-sizing: border-box;
      overflow-x: hidden;
      > .vs__dropdown-option--selected {
        background: #d9e5ff;
        color: #000000;
      }
    }
  }
</style>
