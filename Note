<script>
  import { ref, shallowRef, nextTick } from 'vue' // nextTick 추가
  import { ApiCommon } from '@/utils/axios/api-common'
  import vSelect from 'vue-select'
  import { useEmployees } from '@/stores/app-employees'
  import { debounce } from 'lodash-es'

  const { setEmployeeInfo } = useEmployees()

  export default {
    name: 'AgUserEditor',
    components: { vSelect },
    props: {
      params: { type: Object, default: () => ({}) },
    },
    setup(props) {
      return {
        containerRef: shallowRef(null),
        vSelectRef: shallowRef(null),
        vModelRef: ref(null),
        vOptionsRef: ref([]),
        vValue: ref(null),
      }
    },
    mounted() {
      this.vModelRef = this.params?.editorSelected
      this.vOptionsRef = this.params?.editorOptions ?? []
      this.vValue = this.getInitialValue()
      
      // [포커스 핵심 1] 렌더링이 확실히 끝난 후 포커스를 잡습니다.
      this.focusInput();
    },
    methods: {
      // 포커스를 강제로 잡는 메서드 분리
      focusInput() {
        nextTick(() => {
          setTimeout(() => {
            // v-select의 검색 입력창(searchEl)에 포커스
            if (this.vSelectRef && this.vSelectRef.searchEl) {
              this.vSelectRef.searchEl.focus();
            }
          }, 50); // 그리드 환경에서는 50ms~100ms 정도가 안정적입니다.
        });
      },

      // [포커스 핵심 2] AG-Grid 등의 그리드에서 팝업이 화면에 붙은 후 호출되는 표준 메서드
      afterGuiAttached() {
        this.focusInput();
      },

      getValue() {
        return this.vValue
      },
      getInitialValue() {
        return this.params?.value
      },
      onClosePopup() {
        try {
          if (this.params && typeof this.params.stopEditing === 'function') {
            this.params.stopEditing()
          }
        } catch (e) {
          console.error(e)
        }
      },
      setValue(USER_ID) {
        const newValue = String(USER_ID ?? '')
        this.vValue = newValue === '' ? null : newValue
      },
      getSelectedValue() {
        return this.vModelRef?.code
      },

      onKeydown(event) {
        if (event.target.tagName === 'INPUT') {
          return
        }

        if (event.key === 'Escape' || event.key === 'ESC') {
          event.preventDefault()
          const userId = this.getInitialValue()
          this.setValue(userId)
          this.onClosePopup()
        } else if (event.key === 'Enter') {
          event.preventDefault()
          event.stopPropagation()
          const userId = this.getSelectedValue()
          if (userId) {
            this.setValue(userId)
            this.onClosePopup()
          }
        }
      },

      onSearch: debounce(async function (search, loading) {
        const userName = String(search ?? '').trim()
        if (userName.length < 1) {
          this.vOptionsRef = []
          return
        }

        try {
          loading(true)
          const response = (await ApiCommon.postOfficeFindEmployee({ 
            Type: 'Name', 
            Keyword: userName 
          })) ?? []

          const options = response
            .filter(item => item.EMP_NO)
            .map(item => ({
              ...item,
              code: item.EMP_NO,
              label: `${item.EMP_NM ?? ''}(${item.DEPT_NAME ?? ''})`,
            }))

          if (options.length > 0) {
            setEmployeeInfo(options)
          }

          this.vOptionsRef = options
        } catch (error) {
          this.vOptionsRef = []
        } finally {
          loading(false)
        }
      }, 300),

      onSelected(item) {
        if (item) {
          this.setValue(item.code)
          setTimeout(() => this.containerRef?.focus(), 1)
        }
      },
      
      dropdownShouldOpen(vselect) {
        return !vselect.loading && vselect.open
      },
    },
  }
</script>

<template>
  <div 
    ref="containerRef" 
    class="p-1 bg-white ag-user-editor-container" 
    tabindex="0" 
    @keydown="onKeydown"
  >
    <div class="d-flex flex-row my-1 justify-content-between">
      <span class="badge bg-info">ESC:취소 / Enter:선택</span>
      <span class="badge bg-dark" style="cursor: pointer" @click="onClosePopup">X</span>
    </div>

    <vSelect
      ref="vSelectRef"
      v-model="vModelRef"
      :options="vOptionsRef"
      :taggable="false"
      :filterable="false" 
      :placeholder="'이름 검색 (예: 박정철)'"
      :dropdown-should-open="dropdownShouldOpen"
      :autofocus="true"
      @option:selected="onSelected"
      @search="onSearch"
      @keydown.stop
      class="w-100 ag-user-editor-select"
    >
      <template #no-options="{ searching }">
        <template v-if="searching">검색 결과가 없습니다.</template>
        <template v-else>이름을 입력해 주세요.</template>
      </template>
    </vSelect>
  </div>
</template>

<style scoped lang="scss">
/* 스타일 동일 */
</style>
