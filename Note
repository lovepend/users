<script>
  import { shallowRef } from 'vue'
  import { ApiCommon } from '@/utils/axios/api-common'
  import vSelect from 'vue-select'
  import { useEmployees } from '@/stores/app-employees'
  import { debounce } from 'lodash-es'

  const { setEmployeeInfo } = useEmployees()

  export default {
    name: 'AgUserEditor',
    components: { vSelect },
    props: {
      params: { type: Object, default: () => ({}) },
    },
    setup(props) {
      return {
        containerRef: shallowRef(null),
        vSelectRef: shallowRef(null),
        vModelRef: shallowRef(null),
        vOptionsRef: shallowRef([]),
        vValue: shallowRef(null),
      }
    },
    mounted() {
      this.vModelRef = this.params?.editorSelected
      this.vOptionsRef = this.params?.editorOptions ?? []
      this.vValue = this.getInitialValue()
      
      // 마운트 후 입력창에 포커스
      setTimeout(() => {
        if (this.vSelectRef?.searchEl) {
          this.vSelectRef.searchEl.focus()
        }
      }, 10)
    },
    methods: {
      getValue() {
        return this.vValue
      },
      getInitialValue() {
        return this.params?.value
      },
      onClosePopup() {
        try {
          if (this.params && typeof this.params.stopEditing === 'function') {
            this.params.stopEditing()
          }
        } catch (e) {
          console.error(e)
        }
      },
      setValue(USER_ID) {
        const newValue = String(USER_ID ?? '')
        this.vValue = newValue === '' ? null : newValue
      },
      getSelectedValue() {
        return this.vModelRef?.code
      },

      /**
       * 컨테이너 전체의 키보드 이벤트 핸들러
       */
      onKeydown(event) {
        // [중요] 이벤트 타겟이 INPUT(v-select 입력창)인 경우 
        // 백스페이스나 다른 키 입력이 먹히지 않도록 부모 로직을 타지 않게 합니다.
        if (event.target.tagName === 'INPUT') {
          return
        }

        if (event.key === 'Escape' || event.key === 'ESC') {
          event.preventDefault()
          const userId = this.getInitialValue()
          this.setValue(userId)
          this.onClosePopup()
        } else if (event.key === 'Enter') {
          event.preventDefault()
          event.stopPropagation()
          const userId = this.getSelectedValue()
          if (userId) {
            this.setValue(userId)
            this.onClosePopup()
          }
        }
      },

      /**
       * 한글 조합 및 서버 부하를 고려한 디바운스 검색
       */
      onSearch: debounce(async function (search, loading) {
        const userName = String(search ?? '').trim()
        
        // 검색어가 비어있으면 결과 초기화
        if (userName.length < 1) {
          this.vOptionsRef = []
          return
        }

        try {
          loading(true)
          const response = (await ApiCommon.postOfficeFindEmployee({ 
            Type: 'Name', 
            Keyword: userName 
          })) ?? []

          const options = response
            .filter(item => item.EMP_NO)
            .map(item => ({
              ...item,
              code: item.EMP_NO,
              label: `${item.EMP_NM ?? ''}(${item.DEPT_NAME ?? ''})`,
            }))

          if (options.length > 0) {
            setEmployeeInfo(options)
          }

          this.vOptionsRef = options
        } catch (error) {
          this.vOptionsRef = []
        } finally {
          loading(false)
        }
      }, 300),

      onSelected(item) {
        if (item) {
          this.setValue(item.code)
          // 선택 후 포커스를 다시 부모 div로 옮겨서 Enter 등으로 닫기 쉽게 함
          setTimeout(() => this.containerRef?.focus(), 1)
        }
      },
      
      dropdownShouldOpen(vselect) {
        return !vselect.loading && vselect.open
      },
    },
  }
</script>

<template>
  <div 
    ref="containerRef" 
    class="p-1 bg-white ag-user-editor-container" 
    tabindex="0" 
    @keydown="onKeydown"
  >
    <div class="d-flex flex-row my-1 justify-content-between">
      <span class="badge bg-info">ESC:취소 / Enter:선택</span>
      <span class="badge bg-dark" style="cursor: pointer" @click="onClosePopup">X</span>
    </div>

    <vSelect
      ref="vSelectRef"
      v-model="vModelRef"
      :options="vOptionsRef"
      :taggable="false"
      :filterable="false" 
      :placeholder="'이름 검색 (예: 박정철)'"
      :dropdown-should-open="dropdownShouldOpen"
      @option:selected="onSelected"
      @search="onSearch"
      @keydown.stop
      class="w-100 ag-user-editor-select"
    >
      <template #no-options="{ searching }">
        <template v-if="searching">검색 결과가 없습니다.</template>
        <template v-else>이름을 입력해 주세요.</template>
      </template>
    </vSelect>
  </div>
</template>

<style scoped lang="scss">
  .ag-user-editor-container {
    border: 1px solid #a8beed;
    min-width: 300px;
    width: auto;
    height: auto;
    outline: none; // 포커스 시 테두리 제거
  }
  
  :deep().ag-user-editor-select {
    .vs__dropdown-toggle {
      background: #fff;
      .vs__selected-options {
        flex-wrap: wrap !important;
        .vs__search {
          color: #333;
          margin-top: 4px;
        }
      }
    }
    
    &.vs--searching .vs__search {
      color: #000 !important;
    }

    .vs__dropdown-menu {
      padding: 0.5rem !important;
      border-radius: 5px;
      border: 1px solid rgb(168, 190, 237);
      background-color: #fff;
      max-height: 200px;
      overflow-x: hidden;
      z-index: 9999;
      
      .vs__dropdown-option {
        padding: 8px 12px;
        &--highlight {
          background: #d9e5ff;
          color: #000;
        }
        &--selected {
          background: #d9e5ff;
          font-weight: bold;
        }
      }
    }
  }
</style>
