<template>
  <div id="app">
    <h2 class="page-main-title">ğŸ·ï¸ íƒœê·¸ ë²ˆí˜¸ ìƒì„¸ ì¡°íšŒ ë° ìœ íš¨ì„± ê²€ì‚¬</h2>

    <div class="main-content-wrapper">
      <div class="panel api-pubdata-panel">
        <h3 class="panel-title">Tag No. Pub/Wrk ë°ì´í„° ì¡°íšŒ</h3>

        <div class="input-group">
          <label for="tagNoInputApi">ì¡°íšŒí•  Tag No. ì…ë ¥:</label>
          <input
            id="tagNoInputApi"
            v-model="tagNoForApi"
            type="text"
            placeholder="ì˜ˆ: CheckTest009"
            @keyup.enter="searchTag"
          />
        </div>
        <div class="input-group">
          <label for="projectNoInputApi">í”„ë¡œì íŠ¸ ë²ˆí˜¸:</label>
          <input id="projectNoInputApi" v-model="projectNoInput" type="text" placeholder="ì˜ˆ: TE1002" />
        </div>
        <button @click="searchTag" :disabled="apiLoading" class="action-btn primary-btn">API ìƒì„¸ ì¡°íšŒ</button>

        <div v-if="apiLoading" class="message loading-message">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        <div v-else-if="apiErrorMessage" class="message error-message">ì˜¤ë¥˜: {{ apiErrorMessage }}</div>

        <div v-else-if="apiSearched">
          <div class="results-card" v-if="pubData">
            <h4>âœ¨ Pub ê¸°ë³¸ ì •ë³´</h4>
            <p><strong>TAG_NO:</strong> {{ pubData.TAG_NO }}</p>
            <p><strong>EP_ID:</strong> {{ pubData.EP_ID }}</p>
            <p><strong>CLS_ID:</strong> {{ pubData.CLS_ID }}</p>
          </div>

          <div class="results-card wrk-data-section" v-if="wrkData && wrkData.length > 0">
            <h4>âœ¨ Wrk ë°ì´í„° ë¦¬ìŠ¤íŠ¸ ({{ wrkData.length }}ê±´)</h4>
            <div v-for="(wrkItem, index) in wrkData" :key="wrkItem._id || index" class="wrk-item">
              <div class="wrk-header">
                <span class="badge">Wrk #{{ index + 1 }}</span>
                <strong>{{ wrkItem.EP_ID }} / {{ wrkItem.TAG_IDX }}</strong>
              </div>

              <div v-if="wrkItem.linkedPubData" class="linked-pub-box">
                <h6 class="linked-title">ğŸ”— [ì—°ë™ëœ Pub ë°ì´í„° ì •ë³´]</h6>
                <div class="linked-grid">
                  <p><strong>TAG_NO:</strong> {{ wrkItem.linkedPubData.TAG_NO }}</p>
                  <p><strong>ìƒíƒœ:</strong> {{ wrkItem.linkedPubData.DELETED ? 'ì‚­ì œë¨' : 'ì •ìƒ' }}</p>
                  <p><strong>ìˆ˜ì •ì¼:</strong> {{ formatDate(wrkItem.linkedPubData.CHGE_DTM) }}</p>
                  <div v-if="getValidAttributes(wrkItem.linkedPubData.ATTRIBUTES).length > 0" class="attr-list">
                    <strong>ì£¼ìš” ì†ì„±:</strong>
                    <span v-for="attr in getValidAttributes(wrkItem.linkedPubData.ATTRIBUTES)" :key="attr.ATT_ID" class="attr-tag">
                      {{ attr.ATT_ID }}: {{ attr.VALUE }}
                    </span>
                  </div>
                </div>
              </div>
              <div v-else class="no-linked-pub">
                <small>í•´ë‹¹ TAG_IDXë¡œ ì—°ê²°ëœ Pub ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel tag-split-panel">
        <h3 class="panel-title">Tag Split (ìœ íš¨ì„± ê²€ì‚¬ê¸°)</h3>
        <div class="input-group">
          <label for="tagNoInputValidator">ê²€ì‚¬í•  Tag No. ì…ë ¥:</label>
          <input id="tagNoInputValidator" v-model="tagNoForValidator" type="text" placeholder="ì…ë ¥í•˜ì„¸ìš”..." />
        </div>

        <div class="rules-table-container">
          <div class="table-header">
            <h4>ê·œì¹™ ì„¤ì •</h4>
            <div class="table-btns">
              <button @click="addRule" class="small-btn success">ì¶”ê°€</button>
              <button @click="showPasteModal = true" class="small-btn info">ë¶™ì—¬ë„£ê¸°</button>
            </div>
          </div>
          <table>
            <thead>
              <tr><th>êµ¬ë¶„ì</th><th>ì •ê·œì‹</th><th>ê´€ë¦¬</th></tr>
            </thead>
            <tbody>
              <tr v-for="(rule, index) in tagRules" :key="index">
                <td><input v-model="rule.delimiter" class="table-input" /></td>
                <td><input v-model="rule.regex" class="table-input" /></td>
                <td><button @click="removeRule(index)" class="del-btn">X</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="overall-validation-result">
          <p>ì¢…í•© ìœ íš¨ì„±: 
            <span :class="{ 'valid-txt': isTagNoValid, 'invalid-txt': !isTagNoValid }">
              {{ isTagNoValid ? 'ìœ íš¨í•¨(PASS)' : 'ìœ íš¨í•˜ì§€ ì•ŠìŒ(FAIL)' }}
            </span>
          </p>
        </div>
      </div>
    </div>

    <div v-if="showPasteModal" class="modal-overlay">
      <div class="modal-content">
        <h4>ì—‘ì…€ ë°ì´í„° ë¶™ì—¬ë„£ê¸°</h4>
        <textarea v-model="pasteData" rows="10" placeholder="êµ¬ë¶„ì[íƒ­]ì •ê·œì‹"></textarea>
        <div class="modal-actions">
          <button @click="applyPasteData" class="action-btn primary-btn">ì ìš©</button>
          <button @click="showPasteModal = false" class="action-btn cancel-btn">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, computed } from 'vue'
import { axiosWrapper } from '@/utils/axios/axios-wrapper'

export default {
  setup() {
    const tagNoForApi = ref('')
    const projectNoInput = ref('TE1002')
    const apiSearchedTagNo = ref('')
    const pubData = ref(null)
    const wrkData = ref([])
    const apiLoading = ref(false)
    const apiErrorMessage = ref('')
    const apiSearched = ref(false)

    // Validator ê´€ë ¨
    const tagNoForValidator = ref('AP330X01-')
    const tagRules = ref([
      { delimiter: '', regex: '^$|^[A-Z]{2}$' },
      { delimiter: '', regex: '^[0123LCRIT]{3}$' },
      { delimiter: '', regex: '^[ABCDEFNVXS]{1}$' },
      { delimiter: '-', regex: '^[0-9]{2}$' }
    ])
    const showPasteModal = ref(false)
    const pasteData = ref('')

    // â­ API ë¡œì§ (ì „ë‹¬í•´ì£¼ì‹  ë‹¨ì¼ ê°ì²´ êµ¬ì¡° ë°˜ì˜) â­
    const searchTag = async () => {
      pubData.value = null
      wrkData.value = []
      apiErrorMessage.value = ''
      apiSearched.value = true
      apiLoading.value = true

      try {
        const res = await axiosWrapper.post('/api/Data/GetPubWrkDataByTagNo', {
          ProjectNo: projectNoInput.value,
          TAG_NO: tagNoForApi.value,
          ContainDeleted: true,
        })

        if (res) {
          pubData.value = res.PubData?.[0] || null
          const rawWrk = res.WrkData || []

          // TAG_IDXë¡œ ì¶”ê°€ Pub ì •ë³´ ë³‘ë ¬ ì¡°íšŒ
          const enhancedWrk = await Promise.all(rawWrk.map(async (item) => {
            if (item.TAG_IDX) {
              try {
                const detailRes = await axiosWrapper.post('/api/Data/GetPubDataByID', {
                  ProjectNo: projectNoInput.value,
                  TAG_IDX: item.TAG_IDX
                })
                // â­ ë¦¬í„´ ë°ì´í„°ê°€ ë‹¨ì¼ ê°ì²´ì´ë¯€ë¡œ detailResë¥¼ ë°”ë¡œ í• ë‹¹ â­
                if (detailRes && typeof detailRes === 'object') {
                  return { ...item, linkedPubData: detailRes }
                }
              } catch (e) {
                console.error('ìƒì„¸ì¡°íšŒ ì‹¤íŒ¨:', e)
              }
            }
            return item
          }))
          wrkData.value = enhancedWrk
        }
      } catch (err) {
        apiErrorMessage.value = err.message
      } finally {
        apiLoading.value = false
      }
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    const formatDate = (dt) => dt ? new Date(dt).toLocaleString() : '-'
    const getValidAttributes = (attrs) => {
      if (!attrs) return []
      return attrs.filter(a => a.VALUE && a.VALUE !== 'null' && a.VALUE !== 'false')
    }

    // Validator ë¡œì§
    const isRegexOptional = r => r.startsWith('^$|')
    const combinedRegexString = computed(() => {
      let parts = tagRules.value.map((rule, i) => {
        let p = rule.regex.replace(/^\^|\$$/g, '')
        let s = `(?:${p})`
        if (i > 0 && rule.delimiter) {
          const d = rule.delimiter.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
          s = isRegexOptional(rule.regex) ? `(?:${d}${s})?` : `(?:${d}${s})`
        }
        return s
      })
      return `^${parts.join('')}$`
    })
    const isTagNoValid = computed(() => {
      try { return new RegExp(combinedRegexString.value).test(tagNoForValidator.value) } catch { return false }
    })

    const addRule = () => tagRules.value.push({ delimiter: '', regex: '' })
    const removeRule = (i) => tagRules.value.splice(i, 1)
    const applyPasteData = () => {
      tagRules.value = pasteData.value.trim().split('\n').map(row => {
        const c = row.split('\t')
        return { delimiter: c[0] || '', regex: c[1] || c[0] || '' }
      })
      showPasteModal.value = false
    }

    return {
      tagNoForApi, projectNoInput, pubData, wrkData, apiLoading, apiErrorMessage, apiSearched,
      searchTag, formatDate, getValidAttributes, tagNoForValidator, tagRules, isTagNoValid,
      showPasteModal, pasteData, addRule, removeRule, applyPasteData, combinedRegexString
    }
  }
}
</script>

<style scoped>
#app { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background: #f0f2f5; min-height: 100vh; }
.page-main-title { text-align: center; color: #1a73e8; margin-bottom: 30px; }
.main-content-wrapper { display: flex; gap: 20px; align-items: flex-start; }
.panel { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); flex: 1; }
.panel-title { border-left: 5px solid #1a73e8; padding-left: 10px; margin-bottom: 20px; }

.input-group { margin-bottom: 15px; }
.input-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
.input-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

.action-btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
.primary-btn { background: #1a73e8; color: white; }
.primary-btn:hover { background: #1557b0; }
.cancel-btn { background: #6c757d; color: white; margin-top: 10px; }

.results-card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #e9ecef; }
.wrk-item { padding: 15px; border-bottom: 1px solid #eee; }
.wrk-header { margin-bottom: 10px; display: flex; gap: 10px; align-items: center; }
.badge { background: #e8f0fe; color: #1a73e8; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; }

/* â­ ì—°ë™ ë°ì´í„° ë°•ìŠ¤ â­ */
.linked-pub-box { background: #fff9f0; border: 1px solid #ffe8cc; padding: 12px; border-radius: 6px; margin-top: 10px; }
.linked-title { color: #e67e22; margin: 0 0 8px 0; font-size: 0.95em; }
.linked-grid { display: grid; gap: 5px; font-size: 0.85em; }
.attr-tag { background: #e2e3e5; padding: 2px 6px; border-radius: 4px; margin-right: 5px; display: inline-block; margin-top: 5px; }

/* Validator í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
.table-header { display: flex; justify-content: space-between; align-items: center; }
.small-btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; color: #fff; }
.success { background: #28a745; }
.info { background: #17a2b8; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th { background: #f8f9fa; font-size: 0.85em; padding: 10px; border-bottom: 2px solid #dee2e6; }
td { padding: 5px; border-bottom: 1px solid #eee; }
.table-input { width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; }
.del-btn { background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; }

.overall-validation-result { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; }
.valid-txt { color: #28a745; font-weight: bold; }
.invalid-txt { color: #dc3545; font-weight: bold; }

.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
.modal-content { background: white; padding: 20px; border-radius: 10px; width: 400px; }
.modal-content textarea { width: 100%; margin-top: 10px; border-radius: 4px; border: 1px solid #ddd; }
</style>
