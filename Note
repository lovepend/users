const insertRows = function (rowCount) {
  const grid = gridRef.value;
  if (!grid) return;

  grid.stopEditing();
  grid.setGridOption('loading', true);

  const filterModel = grid.getFilterModel();
  const filterDefaults = {};

  /**
   * 필터 구조에 따라 단일 값 또는 배열을 영리하게 추출하는 함수
   */
  const getSmartFilterValue = (m) => {
    if (!m || typeof m !== 'object') return null;

    // 1. 배열 구조인 경우 (Set Filter 등) -> 배열로 유지 및 대문자 변환
    if (Array.isArray(m.values)) {
      return m.values.map(v => (typeof v === 'string' ? v.trim().toUpperCase() : v));
    }

    // 2. Multi Filter 구조인 경우
    if (m.filterType === 'multi' && Array.isArray(m.filterModels)) {
      // 유효한 필터 모델 하나를 찾아 그 내부 값을 재귀적으로 탐색
      const active = m.filterModels.find(f => f !== null);
      return getSmartFilterValue(active);
    }

    // 3. 복합 조건 (AND/OR) 구조
    if (Array.isArray(m.conditions)) {
      return getSmartFilterValue(m.conditions[0]);
    }
    if (m.condition1) return getSmartFilterValue(m.condition1);

    // 4. 일반적인 단일 값 구조 (Text, Number 등) -> 단일 값으로 반환 및 대문자
    const res = m.filter !== undefined ? m.filter : 
                m.value !== undefined ? m.value : null;

    if (res !== null && typeof res === 'string') {
      return res.trim().toUpperCase();
    }
    return res;
  };

  // 필터 모델 순회
  Object.keys(filterModel).forEach((colId) => {
    const smartVal = getSmartFilterValue(filterModel[colId]);
    if (smartVal !== null && smartVal !== undefined) {
      filterDefaults[colId] = smartVal;
    }
  });

  console.log('추출된 필터 데이터 (구조 유지):', filterDefaults);

  const addRows = [];
  const numRows = parseInt(rowCount) || 1;

  for (let i = 0; i < numRows; i++) {
    const newId = `new_${Math.random().toString(36).substring(2, 12)}`;
    const newRow = {
      STATUS: 'A',
      PROJ_NO: currentProjNo.value,
      ATT_ID: null,
      CL_ID: null,
      VAL_TYPE: (typeof VAL_TYPES !== 'undefined') ? VAL_TYPES.STRING.VALUE : 'STRING',
      RDON_YN: false,
      IGN_LIST_VAL: false,
      CRTER_NO: userInfo.value?.UserID,
      _id: newId,
      ...filterDefaults // 필터 구조에 맞춰 주입
    };
    addRows.push(newRow);
  }

  if (addRows.length > 0) {
    // 필터 해제 시 중간 끼임 방지를 위해 인덱스 없이 추가 (물리적 맨 뒤)
    const result = grid.applyTransaction({ add: addRows });
    
    grid.refreshCells({ force: true, suppressFlash: true });
    
    if (result.add && result.add.length > 0) {
      grid.setNodesSelected({ nodes: result.add, newValue: true });
      const lastIdx = grid.getDisplayedRowCount() - 1;
      grid.ensureIndexVisible(lastIdx, 'bottom');
    }
  }
  
  grid.setGridOption('loading', false);
};

// 핸들러 선언 순서
const onCreateRows = function () {
  if (!currentProjNo.value) {
    sAlert.Warning(`Project를 선택해주세요`);
    return;
  }
  insertRows(1);
};

const onCreateMultiRows = function (rowCount) {
  if (!currentProjNo.value) {
    sAlert.Warning(`Project를 선택해주세요`);
    return;
  }
  const count = (typeof rowCount === 'number') ? rowCount : 1;
  insertRows(count);
};
