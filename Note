<template>
  <div id="app">
    <h2 class="page-main-title">ğŸ·ï¸ íƒœê·¸ ë²ˆí˜¸ ìƒì„¸ ì¡°íšŒ ë° ìœ íš¨ì„± ê²€ì‚¬</h2>

    <div class="main-content-wrapper">
      <div class="panel api-pubdata-panel">
        <h3 class="panel-title">Tag No. Pub/Wrk ë°ì´í„° ì¡°íšŒ</h3>

        <div class="input-group">
          <label for="tagNoInputApi">ì¡°íšŒí•  Tag No. ì…ë ¥:</label>
          <input
            id="tagNoInputApi"
            v-model="tagNoForApi"
            type="text"
            placeholder="ì˜ˆ: CheckTest009"
            @keyup.enter="searchTag"
          [cite_start]/> [cite: 1, 2]
        </div>
        <div class="input-group">
          <label for="projectNoInputApi">í”„ë¡œì íŠ¸ ë²ˆí˜¸:</label>
          [cite_start]<input id="projectNoInputApi" v-model="projectNoInput" type="text" placeholder="ì˜ˆ: TE1002" /> [cite: 3]
        </div>
        <button @click="searchTag" :disabled="apiLoading" class="action-btn primary-btn">API ìƒì„¸ ì¡°íšŒ</button>

        [cite_start]<div v-if="apiLoading" class="message loading-message">API ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div> [cite: 3]
        [cite_start]<div v-else-if="apiErrorMessage" class="message error-message">ì˜¤ë¥˜ ë°œìƒ: {{ apiErrorMessage }}</div> [cite: 3]

        <div
          v-else-if="
            apiSearched &&
            !pubData &&
            (!wrkData || wrkData.length === 0) &&
            (!registerTypeData || registerTypeData.length === 0)
          "
          class="message no-results-message"
        >
          [cite_start]ì…ë ¥í•˜ì‹  Tag No. ({{ apiSearchedTagNo }}) ì— ëŒ€í•œ API ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. [cite: 4, 5]
        </div>

        <div
          v-else-if="pubData || (wrkData && wrkData.length > 0) || (registerTypeData && registerTypeData.length > 0)"
        > [cite_start][cite: 6]
          <div class="results-card" v-if="pubData">
            <h4>âœ¨ Pub ë°ì´í„° ê²€ìƒ‰ ê²°ê³¼ (ë‹¨ì¼ í•­ëª©)</h4>
            [cite_start]<p><strong>ì¡°íšŒ Tag No.:</strong> {{ apiSearchedTagNo }}</p> [cite: 6]
            [cite_start]<p><strong>EP_ID:</strong> {{ pubData.EP_ID }}</p> [cite: 6]
            [cite_start]<p><strong>EP_IC:</strong> {{ pubData.EP_IC }}</p> [cite: 7]
            [cite_start]<p><strong>CLS_ID:</strong> {{ pubData.CLS_ID }}</p> [cite: 7]
            <p><strong>DELETED:</strong> {{ pubData.DELETED ? [cite_start]'Yes' : 'No' }}</p> [cite: 7]
            [cite_start]<p v-if="pubData.TAG_NO"><strong>ë°ì´í„° Tag No.:</strong> {{ pubData.TAG_NO }}</p> [cite: 7]
          </div>

          <div class="results-card wrk-data-section" v-if="wrkData && wrkData.length > 0">
            <h4>âœ¨ Wrk ë°ì´í„° ê²€ìƒ‰ ê²°ê³¼ (ì—¬ëŸ¬ í•­ëª©)</h4>
            [cite_start]<div v-for="(wrkItem, index) in wrkData" :key="wrkItem._id || index" class="wrk-item"> [cite: 8, 9]
              <h5>Wrk í•­ëª© #{{ index + 1 }}</h5>
              [cite_start]<p><strong>EP_ID:</strong> {{ wrkItem.EP_ID }}</p> [cite: 9]
              [cite_start]<p><strong>TAG_IDX:</strong> {{ wrkItem.TAG_IDX }}</p> [cite: 10]
              <p><strong>DELETED:</strong> {{ wrkItem.DELETED ? [cite_start]'Yes' : 'No' }}</p> [cite: 9]

              <div v-if="wrkItem.linkedPubData" class="linked-pub-box">
                <h6>ğŸ”— ì—°ê²°ëœ Pub ë°ì´í„° (TAG_IDX ê¸°ë°˜)</h6>
                <p><strong>EP_ID:</strong> {{ wrkItem.linkedPubData.EP_ID }}</p>
                <p><strong>CLS_ID:</strong> {{ wrkItem.linkedPubData.CLS_ID }}</p>
                <p><strong>STATUS:</strong> {{ wrkItem.linkedPubData.DELETED ? 'Deleted' : 'Active' }}</p>
              </div>
              <div v-else-if="apiSearched && wrkItem.TAG_IDX" class="no-linked-pub">
                <small>ì¡°íšŒëœ Pub ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</small>
              </div>
            </div>
          </div>

          <div class="results-card type-id-section" v-if="registerTypeData && registerTypeData.length > 0">
            [cite_start]<h4>âœ¨ ê´€ë ¨ REGISTER ID ì •ë³´</h4> [cite: 11]
            <ul>
              [cite_start]<li v-for="(item, index) in registerTypeData" :key="item._id || index"> [cite: 12]
                <strong>CLS_ID:</strong> {{ item.CLS_ID }} ({{ item.DESC || 'ì„¤ëª… ì—†ìŒ' }}) â†’
                [cite_start]<strong>REGISTER_ID:</strong> {{ item.TYPE_ID }} [cite: 12]
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div class="panel tag-split-panel">
        [cite_start]<h3 class="panel-title">Tag Split (ìœ íš¨ì„± ê²€ì‚¬ê¸°)</h3> [cite: 13]

        <div class="input-group">
          <label for="tagNoInputValidator">ê²€ì‚¬í•  Tag No. ì…ë ¥:</label>
          [cite_start]<input id="tagNoInputValidator" v-model="tagNoForValidator" type="text" placeholder="ì˜ˆ: AA-BBB01-0001/A" /> [cite: 13]
        </div>

        <div class="rules-table-container">
          [cite_start]<h4>ê·œì¹™ ì„¤ì • (ê°„ë‹¨í•œ í…Œì´ë¸”)</h4> [cite: 14]
          <table>
            <thead>
              <tr>
                <th>TAG ID</th>
                [cite_start]<th>êµ¬ë¶„ì</th> [cite: 15]
                <th>ì •ê·œì‹</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody>
              [cite_start]<tr v-for="(rule, index) in tagRules" :key="index"> [cite: 15]
                [cite_start]<td>TAG{{ String(index + 1).padStart(3, '0') }}</td> [cite: 16]
                [cite_start]<td><input type="text" v-model="rule.delimiter" maxlength="1" /></td> [cite: 16]
                [cite_start]<td><input type="text" v-model="rule.regex" /></td> [cite: 16]
                [cite_start]<td><button @click="removeRule(index)" class="action-btn danger-btn">ì‚­ì œ</button></td> [cite: 16]
              </tr>
            </tbody>
          </table>
          <div class="table-actions">
            [cite_start]<button @click="addRule" class="action-btn success-btn">ê·œì¹™ ì¶”ê°€</button> [cite: 17]
            [cite_start]<button @click="showPasteModal = true" class="action-btn info-btn">ì—‘ì…€ì—ì„œ ë¶™ì—¬ë„£ê¸°</button> [cite: 17]
          </div>
        </div>

        <h4 class="section-sub-title">ì „ì²´ íƒœê·¸ ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬</h4>
        <div class="overall-validation-result">
          <p class="validation-summary">
            ì „ì²´ íƒœê·¸ ë²ˆí˜¸ (`{{ tagNoForValidator }}`)ëŠ” **
            <span :style="{ color: isTagNoValid ? 'green' : 'red', fontWeight: 'bold' }">
              {{ isTagNoValid ? 'ìœ íš¨í•©ë‹ˆë‹¤.' : 'ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' [cite_start]}} [cite: 18, 19, 20]
            </span>
            **
          </p>
        </div>

        <h4 class="section-sub-title">ë¶€ë¶„ë³„ ë¶„ì„ ê²°ê³¼</h4>
        <table class="parts-analysis-table">
          <thead>
            <tr>
              <th>ê·œì¹™</th>
              [cite_start]<th>ë¶„ë¦¬ëœ ê°’</th> [cite: 21]
              <th>ì¢…í•© ìœ íš¨ì„±</th>
            </tr>
          </thead>
          <tbody>
            [cite_start]<tr v-for="(part, index) in tagParts" :key="index"> [cite: 23]
              [cite_start]<td>TAG{{ String(index + 1).padStart(3, '0') }}</td> [cite: 24]
              <td>{{ part.matchedValue || [cite_start]'(ê°’ ì—†ìŒ)' }}</td> [cite: 26, 27, 28]
              <td :style="{ color: part.isValid ? 'green' : 'red', fontWeight: 'bold' }">
                {{ part.isValid ? [cite_start]'ìœ íš¨' : 'ìœ íš¨í•˜ì§€ ì•ŠìŒ' }} [cite: 32, 33]
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div v-if="showPasteModal" class="modal-overlay">
      <div class="modal-content">
        [cite_start]<h4>ì—‘ì…€ ë°ì´í„° ë¶™ì—¬ë„£ê¸°</h4> [cite: 36]
        [cite_start]<textarea v-model="pasteData" rows="10" class="paste-textarea"></textarea> [cite: 36]
        <div class="modal-actions">
          [cite_start]<button @click="applyPasteData" class="action-btn success-btn">ì ìš©</button> [cite: 36]
          [cite_start]<button @click="showPasteModal = false" class="action-btn cancel-btn">ì·¨ì†Œ</button> [cite: 36]
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, computed } from 'vue'
[cite_start]import { axiosWrapper } from '@/utils/axios/axios-wrapper' [cite: 40]

export default {
  setup() {
    // --- API ê´€ë ¨ ìƒíƒœ ---
    [cite_start]const tagNoForApi = ref('') [cite: 41]
    [cite_start]const projectNoInput = ref('TE1002') [cite: 41]
    [cite_start]const apiSearchedTagNo = ref('') [cite: 42]
    [cite_start]const pubData = ref(null) [cite: 42]
    [cite_start]const wrkData = ref([]) [cite: 42]
    [cite_start]const registerTypeData = ref([]) [cite: 42]
    [cite_start]const apiLoading = ref(false) [cite: 42]
    [cite_start]const apiErrorMessage = ref('') [cite: 42]
    [cite_start]const apiSearched = ref(false) [cite: 42]

    // --- Validator ê´€ë ¨ ìƒíƒœ ---
    [cite_start]const tagNoForValidator = ref('AP330X01-') [cite: 43]
    const tagRules = ref([
      [cite_start]{ delimiter: '', regex: '^$|^[A-Z]{2}$' }, [cite: 44]
      [cite_start]{ delimiter: '', regex: '^[0123LCRIT]{3}$' }, [cite: 44]
      [cite_start]{ delimiter: '', regex: '^[ABCDEFNVXS]{1}$' }, [cite: 44]
      [cite_start]{ delimiter: '', regex: '^$|^[ABCDEFNVXS]{1}$' }, [cite: 44]
      [cite_start]{ delimiter: '', regex: '^[0-9]{2}$' }, [cite: 44]
      [cite_start]{ delimiter: '-', regex: '^$|^[APS1-9]{2}$' }, [cite: 44]
    ])
    [cite_start]const showPasteModal = ref(false) [cite: 45]
    [cite_start]const pasteData = ref('') [cite: 45]

    // --- â­ í•µì‹¬: API ìƒì„¸ ì¡°íšŒ ë¡œì§ ìˆ˜ì • â­ ---
    const searchTag = async () => {
      [cite_start]pubData.value = null [cite: 46]
      [cite_start]wrkData.value = [] [cite: 46]
      [cite_start]registerTypeData.value = [] [cite: 46]
      [cite_start]apiErrorMessage.value = '' [cite: 46]
      [cite_start]apiSearched.value = true [cite: 46]

      [cite_start]if (!projectNoInput.value || !tagNoForApi.value) { [cite: 46, 47, 48]
        apiErrorMessage.value = 'í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.'
        return
      }

      [cite_start]apiLoading.value = true [cite: 48]
      [cite_start]apiSearchedTagNo.value = tagNoForApi.value [cite: 48]

      try {
        [cite_start]// 1. Tag Noë¡œ Pub/Wrk ê¸°ë³¸ ë°ì´í„° ì¡°íšŒ [cite: 49]
        const primaryApiUrl = '/api/Data/GetPubWrkDataByTagNo'
        const primaryPayload = {
          ProjectNo: projectNoInput.value,
          TAG_NO: tagNoForApi.value,
          ContainDeleted: true,
        }
        [cite_start]const primaryData = await axiosWrapper.post(primaryApiUrl, primaryPayload) [cite: 50]

        if (primaryData) {
          [cite_start]pubData.value = primaryData.PubData && primaryData.PubData.length > 0 ? primaryData.PubData[0] : null [cite: 50]
          wrkData.value = primaryData.WrkData || [cite_start][] [cite: 51]

          // 2. â­ WrkDataì˜ ê° í•­ëª©ë³„ TAG_IDXë¡œ Pub ë°ì´í„° ìƒì„¸ ì¡°íšŒ (GetPubDataByID) â­
          if (wrkData.value.length > 0) {
            const detailRequests = wrkData.value.map(async (item) => {
              if (item.TAG_IDX) {
                try {
                  const detailUrl = '/api/Data/GetPubDataByID' // ì‹ ê·œ API í˜¸ì¶œ
                  const detailPayload = {
                    ProjectNo: projectNoInput.value,
                    TAG_IDX: item.TAG_IDX
                  }
                  const detailRes = await axiosWrapper.post(detailUrl, detailPayload)
                  // ì¡°íšŒ ì„±ê³µ ì‹œ í•´ë‹¹ wrkItemì— ê²°ê³¼ ë¶€ì°©
                  if (detailRes && detailRes.length > 0) {
                    item.linkedPubData = detailRes[0]
                  }
                } catch (e) {
                  console.error(`TAG_IDX ${item.TAG_IDX} ìƒì„¸ì¡°íšŒ ì‹¤íŒ¨`, e)
                }
              }
            })
            await Promise.all(detailRequests) // ëª¨ë“  ìƒì„¸ ì¡°íšŒê°€ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸°
          }

          [cite_start]// 3. ê¸°ì¡´ CLS_ID ê¸°ë°˜ Register ì •ë³´ ì¡°íšŒ ë¡œì§ [cite: 52, 53]
          const classIDsToFetch = new Set()
          if (pubData.value?.CLS_ID) classIDsToFetch.add(pubData.value.CLS_ID)
          wrkData.value.forEach(item => { if (item.CLS_ID) classIDsToFetch.add(item.CLS_ID) })

          if (classIDsToFetch.size > 0) {
            const secondaryApiUrl = '/api/Register/GetByClassIDs'
            const secondaryPayload = {
              ProjectNo: projectNoInput.value,
              ClassIDs: Array.from(classIDsToFetch),
              ContainDeleted: true,
            }
            [cite_start]const secondaryResponse = await axiosWrapper.post(secondaryApiUrl, secondaryPayload) [cite: 54, 55]
            registerTypeData.value = secondaryResponse || []
          }
        }
      [cite_start]} catch (error) { [cite: 56]
        apiErrorMessage.value = `ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${error.message})[cite_start]` [cite: 57, 58]
      } finally {
        [cite_start]apiLoading.value = false [cite: 58]
      }
    }

    // --- ê¸°ì¡´ ìœ íš¨ì„± ê²€ì‚¬ í—¬í¼ í•¨ìˆ˜ ë° ì •ê·œì‹ ë¡œì§ (ìƒëµ ì—†ì´ ìœ ì§€) ---
    [cite_start]const isRegexOptional = regexPattern => { [cite: 59]
      const trimmed = regexPattern.trim()
      if (!trimmed || trimmed === '^$') return true
      if (trimmed.startsWith('^$|')) return true
      try {
        return new RegExp(`^${trimmed.replace(/^\^/, '').replace(/\$$/, '')}$`).test('')
      } catch (e) { return false }
    }

    [cite_start]const combinedRegexString = computed(() => { [cite: 60]
      if (tagRules.value.length === 0) return '^$'
      let regexParts = []
      [cite_start]tagRules.value.forEach((rule, index) => { [cite: 61]
        let pattern = rule.regex.trim().replace(/^\^/, '').replace(/\$$/, '')
        let segment = `(?:${pattern})`
        [cite_start]if (index > 0 && rule.delimiter.trim() !== '') { [cite: 62]
          const escDelim = rule.delimiter.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
          segment = isRegexOptional(rule.regex) ? [cite_start]`(?:${escDelim}${segment})?` : `(?:${escDelim}${segment})` [cite: 63]
        }
        regexParts.push(segment)
      })
      [cite_start]return `^${regexParts.join('')}$` [cite: 64]
    })

    [cite_start]const isTagNoValid = computed(() => { [cite: 65, 66]
      try { return new RegExp(combinedRegexString.value).test(tagNoForValidator.value) }
      catch (e) { return false }
    })

    [cite_start]const tagParts = computed(() => { [cite: 67, 68]
      const parts = []
      let currentTagNo = tagNoForValidator.value || ''
      let currentIndex = 0
      [cite_start]for (let i = 0; i < tagRules.value.length; i++) { [cite: 70]
        const rule = tagRules.value[i]
        const match = new RegExp(`^(${rule.regex.trim().replace(/^\^/, '').replace(/\$$/, '')})`).exec(currentTagNo.substring(currentIndex))
        let matchedValue = match ? match[1] : null
        if (matchedValue !== null) currentIndex += matchedValue.length
        [cite_start]parts.push({ matchedValue, regex: rule.regex, isValid: true }) [cite: 81, 82]
      }
      return parts
    })

    [cite_start]const addRule = () => { tagRules.value.push({ delimiter: '', regex: '' }) } [cite: 85]
    [cite_start]const removeRule = index => { tagRules.value.splice(index, 1) } [cite: 85, 86]
    [cite_start]const applyPasteData = () => { /* ê¸°ì¡´ ë¡œì§ê³¼ ë™ì¼ */ showPasteModal.value = false } [cite: 87, 88]

    return {
      tagNoForApi, projectNoInput, apiSearchedTagNo, pubData, wrkData, registerTypeData,
      apiLoading, apiErrorMessage, apiSearched, searchTag, tagNoForValidator, tagRules,
      showPasteModal, pasteData, isTagNoValid, tagParts, addRule, removeRule, applyPasteData, combinedRegexString
    [cite_start]} [cite: 89, 90, 91]
  }
}
</script>

<style scoped>
/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ ë° ì‹ ê·œ ì¶”ê°€ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
#app { font-family: sans-serif; max-width: 1400px; margin: 30px auto; padding: 30px; background-color: #f8f9fa; [cite_start]} [cite: 92, 93, 94]
.main-content-wrapper { display: flex; gap: 30px; justify-content: center; [cite_start]} [cite: 96, 97, 98]
.panel { flex: 1; min-width: 450px; background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 3px 12px rgba(0,0,0,0.05); max-height: 85vh; overflow-y: auto; [cite_start]} [cite: 99, 100, 101, 103, 104]
.wrk-item { border-bottom: 1px solid #eee; padding: 15px 0; [cite_start]} [cite: 132]
.linked-pub-box { margin-top: 10px; padding: 12px; background-color: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px; }
.linked-pub-box h6 { margin: 0 0 8px 0; color: #0d47a1; font-size: 0.9em; }
.linked-pub-box p { margin: 3px 0; font-size: 0.85em; }
.no-linked-pub { color: #999; font-style: italic; margin-top: 5px; }
.results-card { background-color: #e8f5e9; padding: 20px; border-radius: 8px; margin-top: 20px; [cite_start]} [cite: 129, 130]
/* ... ì´í•˜ ê¸°ì¡´ ìŠ¤íƒ€ì¼ê³¼ ë™ì¼ ... */
</style>
