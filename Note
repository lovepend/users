<template>
  <div id="app">
    <h2 class="page-main-title">ğŸ·ï¸ íƒœê·¸ ë²ˆí˜¸ ìƒì„¸ ì¡°íšŒ ë° ìœ íš¨ì„± ê²€ì‚¬</h2>

    <div class="main-content-wrapper">
      <div class="panel api-pubdata-panel">
        <h3 class="panel-title">Tag No. Pub/Wrk ë°ì´í„° ì¡°íšŒ</h3>

        <div class="input-group">
          <label for="tagNoInputApi">ì¡°íšŒí•  Tag No. ì…ë ¥:</label>
          <input
            id="tagNoInputApi"
            v-model="tagNoForApi"
            type="text"
            placeholder="ì˜ˆ: CheckTest009"
            @keyup.enter="searchTag"
          />
        </div>
        <div class="input-group">
          <label for="projectNoInputApi">í”„ë¡œì íŠ¸ ë²ˆí˜¸:</label>
          <input id="projectNoInputApi" v-model="projectNoInput" type="text" placeholder="ì˜ˆ: TE1002" />
        </div>
        <button @click="searchTag" :disabled="apiLoading" class="action-btn primary-btn">API ìƒì„¸ ì¡°íšŒ</button>

        <div v-if="apiLoading" class="message loading-message">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        <div v-else-if="apiErrorMessage" class="message error-message">ì˜¤ë¥˜: {{ apiErrorMessage }}</div>

        <div v-else-if="apiSearched">
          <div class="results-card" v-if="pubData">
            <h4>âœ¨ Pub ê¸°ë³¸ ì •ë³´</h4>
            [cite_start]<p><strong>TAG_NO:</strong> {{ pubData.TAG_NO }} [cite: 3]</p>
            [cite_start]<p><strong>EP_ID:</strong> {{ pubData.EP_ID }} [cite: 4]</p>
            [cite_start]<p><strong>CLS_ID:</strong> {{ pubData.CLS_ID }} [cite: 4]</p>
          </div>

          <div class="results-card wrk-data-section" v-if="wrkData && wrkData.length > 0">
            [cite_start]<h4>âœ¨ Wrk ë°ì´í„° ë¦¬ìŠ¤íŠ¸ ({{ wrkData.length }}ê±´) [cite: 4]</h4>
            <div v-for="(wrkItem, index) in wrkData" :key="wrkItem._id || index" class="wrk-item">
              <div class="wrk-header">
                [cite_start]<span class="badge">Wrk #{{ index + 1 }}</span> [cite: 5, 36]
                [cite_start]<strong>{{ wrkItem.EP_ID }} / {{ wrkItem.TAG_IDX }}</strong> [cite: 5]
              </div>
              
              <p><strong>DEL_YN:</strong> {{ wrkItem.DEL_YN ? 'Yes' : 'No' }}</p>

              <div class="pub-check-line">
                <strong>ì—°ê³„ëœ Pub ë°ì´í„°:</strong> 
                <span v-if="wrkItem.linkedPubData" style="color: #28a745; font-weight: bold;"> ì¡´ì¬í•¨ (TAG_IDX: {{ wrkItem.linkedPubData.TAG_IDX }})</span>
                <span v-else style="color: #dc3545;"> ì¡´ì¬í•˜ì§€ ì•ŠìŒ</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel tag-split-panel">
        [cite_start]<h3 class="panel-title">Tag Split (ìœ íš¨ì„± ê²€ì‚¬ê¸°)</h3> [cite: 9]
        <div class="input-group">
          [cite_start]<label for="tagNoInputValidator">ê²€ì‚¬í•  Tag No. ì…ë ¥:</label> [cite: 9]
          [cite_start]<input id="tagNoInputValidator" v-model="tagNoForValidator" type="text" placeholder="ì…ë ¥í•˜ì„¸ìš”..." /> [cite: 10]
        </div>

        <div class="rules-table-container">
          <div class="table-header">
            [cite_start]<h4>ê·œì¹™ ì„¤ì •</h4> [cite: 11]
            <div class="table-btns">
              [cite_start]<button @click="addRule" class="small-btn success">ì¶”ê°€</button> [cite: 11, 41]
              [cite_start]<button @click="showPasteModal = true" class="small-btn info">ë¶™ì—¬ë„£ê¸°</button> [cite: 11, 41]
            </div>
          </div>
          <table>
            <thead>
              [cite_start]<tr><th>êµ¬ë¶„ì</th><th>ì •ê·œì‹</th><th>ê´€ë¦¬</th></tr> [cite: 11]
            </thead>
            <tbody>
              <tr v-for="(rule, index) in tagRules" :key="index">
                [cite_start]<td><input v-model="rule.delimiter" class="table-input" /></td> [cite: 12]
                [cite_start]<td><input v-model="rule.regex" class="table-input" /></td> [cite: 12]
                [cite_start]<td><button @click="removeRule(index)" class="del-btn">X</button></td> [cite: 12, 44]
              </tr>
            </tbody>
          </table>
        </div>

        <div class="overall-validation-result">
          <p>ì¢…í•© ìœ íš¨ì„±: 
            <span :class="{ 'valid-txt': isTagNoValid, 'invalid-txt': !isTagNoValid }">
              {{ isTagNoValid ? [cite_start]'ìœ íš¨í•¨(PASS)' : 'ìœ íš¨í•˜ì§€ ì•ŠìŒ(FAIL)' }} [cite: 13, 14]
            </span>
          </p>
        </div>
      </div>
    </div>

    [cite_start]<div v-if="showPasteModal" class="modal-overlay"> [cite: 14, 46]
      <div class="modal-content">
        [cite_start]<h4>ì—‘ì…€ ë°ì´í„° ë¶™ì—¬ë„£ê¸°</h4> [cite: 15, 47]
        [cite_start]<textarea v-model="pasteData" rows="10" placeholder="êµ¬ë¶„ì[íƒ­]ì •ê·œì‹"></textarea> [cite: 15, 47]
        <div class="modal-actions">
          [cite_start]<button @click="applyPasteData" class="action-btn primary-btn">ì ìš©</button> [cite: 15]
          [cite_start]<button @click="showPasteModal = false" class="action-btn cancel-btn">ì·¨ì†Œ</button> [cite: 15, 34]
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, computed } from 'vue'
import { axiosWrapper } from '@/utils/axios/axios-wrapper'

export default {
  setup() {
    [cite_start]const tagNoForApi = ref('') [cite: 16]
    [cite_start]const projectNoInput = ref('TE1002') [cite: 16]
    [cite_start]const apiSearchedTagNo = ref('') [cite: 16]
    [cite_start]const pubData = ref(null) [cite: 16]
    [cite_start]const wrkData = ref([]) [cite: 16]
    [cite_start]const apiLoading = ref(false) [cite: 16]
    [cite_start]const apiErrorMessage = ref('') [cite: 16]
    [cite_start]const apiSearched = ref(false) [cite: 16]

    [cite_start]const tagNoForValidator = ref('AP330X01-') [cite: 16]
    const tagRules = ref([
      { delimiter: '', regex: '^$|^[A-Z]{2}$' },
      { delimiter: '', regex: '^[0123LCRIT]{3}$' },
      { delimiter: '', regex: '^[ABCDEFNVXS]{1}$' },
      { delimiter: '-', regex: '^[0-9]{2}$' }
    [cite_start]]) [cite: 16]
    [cite_start]const showPasteModal = ref(false) [cite: 16]
    [cite_start]const pasteData = ref('') [cite: 16]

    const searchTag = async () => {
      [cite_start]pubData.value = null [cite: 17]
      [cite_start]wrkData.value = [] [cite: 17]
      [cite_start]apiErrorMessage.value = '' [cite: 17]
      [cite_start]apiSearched.value = true [cite: 17]
      [cite_start]apiLoading.value = true [cite: 17]

      try {
        const res = await axiosWrapper.post('/api/Data/GetPubWrkDataByTagNo', {
          [cite_start]ProjectNo: projectNoInput.value, [cite: 18]
          [cite_start]TAG_NO: tagNoForApi.value, [cite: 17]
          [cite_start]ContainDeleted: true, [cite: 18]
        })

        if (res) {
          pubData.value = res.PubData?.[0] [cite_start]|| null [cite: 18, 19]
          const rawWrk = res.WrkData || [cite_start][] [cite: 19, 20]

          // ê° Wrk í•­ëª©ì˜ TAG_IDXë¡œ ì—°ê³„ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì—¬ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          const enhancedWrk = await Promise.all(rawWrk.map(async (item) => {
            if (item.TAG_IDX) {
              try {
                const detailRes = await axiosWrapper.post('/api/Data/GetPubDataByID', {
                  [cite_start]ProjectNo: projectNoInput.value, [cite: 21]
                  [cite_start]TAG_IDX: item.TAG_IDX [cite: 21]
                })
                // ë°ì´í„°ê°€ ê°ì²´ í˜•íƒœë¡œ ì¡´ì¬í•˜ë©´ linkedPubDataì— ì €ì¥
                if (detailRes && typeof detailRes === 'object') {
                  [cite_start]return { ...item, linkedPubData: detailRes } [cite: 22]
                }
              } catch (e) {
                console.error('ìƒì„¸ì¡°íšŒ ì‹¤íŒ¨:', e)
              }
            }
            [cite_start]return item [cite: 22]
          }))
          [cite_start]wrkData.value = enhancedWrk [cite: 23]
        }
      } catch (err) {
        [cite_start]apiErrorMessage.value = err.message [cite: 23]
      } finally {
        [cite_start]apiLoading.value = false [cite: 23]
      }
    }

    [cite_start]const formatDate = (dt) => dt ? new Date(dt).toLocaleString() : '-' [cite: 24]
    const getValidAttributes = (attrs) => {
      [cite_start]if (!attrs) return [] [cite: 24]
      [cite_start]return attrs.filter(a => a.VALUE && a.VALUE !== 'null' && a.VALUE !== 'false') [cite: 24]
    }

    [cite_start]const isRegexOptional = r => r.startsWith('^$|') [cite: 24]
    const combinedRegexString = computed(() => {
      let parts = tagRules.value.map((rule, i) => {
        [cite_start]let p = rule.regex.replace(/^\^|\$$/g, '') [cite: 25]
        [cite_start]let s = `(?:${p})` [cite: 25]
        if (i > 0 && rule.delimiter) {
          [cite_start]const d = rule.delimiter.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') [cite: 25]
          s = isRegexOptional(rule.regex) ? [cite_start]`(?:${d}${s})?` : `(?:${d}${s})` [cite: 25]
        }
        return s
      })
      [cite_start]return `^${parts.join('')}$` [cite: 25]
    })
    const isTagNoValid = computed(() => {
      [cite_start]try { return new RegExp(combinedRegexString.value).test(tagNoForValidator.value) } [cite: 25]
      [cite_start]catch { return false } [cite: 26]
    })

    [cite_start]const addRule = () => tagRules.value.push({ delimiter: '', regex: '' }) [cite: 26]
    [cite_start]const removeRule = (i) => tagRules.value.splice(i, 1) [cite: 26]
    const applyPasteData = () => {
      tagRules.value = pasteData.value.trim().split('\n').map(row => {
        [cite_start]const c = row.split('\t') [cite: 27]
        return { delimiter: c[0] || '', regex: c[1] || c[0] || [cite_start]'' } [cite: 27]
      })
      [cite_start]showPasteModal.value = false [cite: 27]
    }

    return {
      tagNoForApi, projectNoInput, pubData, wrkData, apiLoading, apiErrorMessage, apiSearched,
      searchTag, formatDate, getValidAttributes, tagNoForValidator, tagRules, isTagNoValid,
      showPasteModal, pasteData, addRule, removeRule, applyPasteData, combinedRegexString
    }
  }
}
</script>

<style scoped>
/* ê¸°ì¡´ Note.txtì˜ ìŠ¤íƒ€ì¼ì„ 100% ë³´ì¡´í•©ë‹ˆë‹¤ */
#app { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background: #f0f2f5; min-height: 100vh; [cite_start]} [cite: 28]
.page-main-title { text-align: center; color: #1a73e8; margin-bottom: 30px; [cite_start]} [cite: 28]
.main-content-wrapper { display: flex; gap: 20px; align-items: flex-start; [cite_start]} [cite: 28, 29]
.panel { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); flex: 1; [cite_start]} [cite: 29, 30]
.panel-title { border-left: 5px solid #1a73e8; padding-left: 10px; margin-bottom: 20px; [cite_start]} [cite: 30]

.input-group { margin-bottom: 15px; [cite_start]} [cite: 30]
.input-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; [cite_start]} [cite: 31]
.input-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; [cite_start]} [cite: 31, 32]

.action-btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; [cite_start]} [cite: 32, 33]
.primary-btn { background: #1a73e8; color: white; [cite_start]} [cite: 33]
.primary-btn:hover { background: #1557b0; [cite_start]} [cite: 33]
.cancel-btn { background: #6c757d; color: white; margin-top: 10px; [cite_start]} [cite: 33, 34]

.results-card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #e9ecef; [cite_start]} [cite: 34]
.wrk-item { padding: 15px; border-bottom: 1px solid #eee; [cite_start]} [cite: 34, 35]
.wrk-header { margin-bottom: 10px; display: flex; gap: 10px; align-items: center; [cite_start]} [cite: 35]
.badge { background: #e8f0fe; color: #1a73e8; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; [cite_start]} [cite: 35, 36]

/* ì¶”ê°€ëœ í•œ ì¤„ ë””ìì¸ */
.pub-check-line { margin-top: 8px; font-size: 0.9em; border-top: 1px dashed #ddd; padding-top: 8px; }

.table-header { display: flex; justify-content: space-between; align-items: center; [cite_start]} [cite: 40]
.small-btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; color: #fff; [cite_start]} [cite: 40]
.success { background: #28a745; [cite_start]} [cite: 40, 41]
.info { background: #17a2b8; [cite_start]} [cite: 41]
table { width: 100%; border-collapse: collapse; margin-top: 10px; [cite_start]} [cite: 41]
th { background: #f8f9fa; font-size: 0.85em; padding: 10px; border-bottom: 2px solid #dee2e6; [cite_start]} [cite: 41, 42]
td { padding: 5px; border-bottom: 1px solid #eee; [cite_start]} [cite: 42]
.table-input { width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; [cite_start]} [cite: 42, 43]
.del-btn { background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; [cite_start]} [cite: 43, 44]

.overall-validation-result { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; [cite_start]} [cite: 44]
.valid-txt { color: #28a745; font-weight: bold; [cite_start]} [cite: 44, 45]
.invalid-txt { color: #dc3545; font-weight: bold; [cite_start]} [cite: 45]

.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; [cite_start]} [cite: 46]
.modal-content { background: white; padding: 20px; border-radius: 10px; width: 400px; [cite_start]} [cite: 46, 47]
.modal-content textarea { width: 100%; margin-top: 10px; border-radius: 4px; border: 1px solid #ddd; [cite_start]} [cite: 47]
</style>
