// 1. 객체 정의
const gridOptions = {
  isExternalFilterPresent: () => true,
  doesExternalFilterPass: (node) => {
    if (node.data && node.data.STATUS === 'A') return true;
    return true; 
  }
};

// 2. HTML 템플릿 부분에서 연결 확인
// <ag-grid-vue 
//    :gridOptions="gridOptions"  <-- 이 부분이 있는지 확인하세요!
//    ... 
// />



// 기존에 어딘가 선언되어 있을 gridOptions를 찾아 아래 내용을 추가하세요.
gridOptions.isExternalFilterPresent = () => true;
gridOptions.doesExternalFilterPass = (node) => {
  if (node.data && node.data.STATUS === 'A') return true;
  return true;
};



const insertRows = function (rowCount) {
  const grid = gridRef.value;
  if (!grid) return;

  grid.stopEditing();
  grid.setGridOption('loading', true);

  // 1. 현재 적용된 필터 모델 가져오기
  const filterModel = grid.getFilterModel();
  const filterDefaults = {};

  // 2. 필터 구조를 자동 감지해서 값을 추출하는 함수
  const autoDetectAndExtract = (m) => {
    if (!m || typeof m !== 'object') return { value: null, isArray: false };

    // Set 필터인 경우 (배열)
    if (Array.isArray(m.values)) return { value: m.values, isArray: true };

    // Multi 필터인 경우 (재귀 탐색 후 배열 성격 유지)
    if (m.filterType === 'multi' || Array.isArray(m.filterModels)) {
      const active = (m.filterModels || []).find(f => f !== null);
      const extracted = autoDetectAndExtract(active);
      return { value: extracted.value, isArray: true };
    }

    // 일반 단일 필터
    const singleVal = m.filter !== undefined ? m.filter : (m.value !== undefined ? m.value : null);
    return { value: singleVal, isArray: false };
  };

  // 3. 추출 및 대문자 변환
  Object.keys(filterModel).forEach((colId) => {
    const { value, isArray } = autoDetectAndExtract(filterModel[colId]);
    if (value !== null) {
      const toUpper = (v) => (typeof v === 'string' ? v.trim().toUpperCase() : v);
      filterDefaults[colId] = isArray 
        ? (Array.isArray(value) ? value.map(toUpper) : [toUpper(value)]) 
        : toUpper(value);
    }
  });

  // 4. 새 행 생성 및 추가
  const addRows = [];
  const count = parseInt(rowCount) || 1;
  for (let i = 0; i < count; i++) {
    const newId = `new_${Math.random().toString(36).substring(2, 12)}`;
    addRows.push({
      STATUS: 'A',
      PROJ_NO: currentProjNo.value,
      CRTER_NO: userInfo.value?.UserID,
      _id: newId,
      ...filterDefaults // ★ 여기에 필터값이 들어가서 화면에서 안 사라짐!
    });
  }

  if (addRows.length > 0) {
    const result = grid.applyTransaction({ add: addRows }); // addIndex 제거 (맨 뒤 추가)
    grid.refreshCells({ force: true, suppressFlash: true });
    
    if (result.add && result.add.length > 0) {
      grid.setNodesSelected({ nodes: result.add, newValue: true });
      const lastIdx = grid.getDisplayedRowCount() - 1;
      grid.ensureIndexVisible(lastIdx, 'bottom');

      // 사용자가 바로 수정할 수 있게 첫 번째 셀 포커스
      setTimeout(() => {
        grid.setFocusedCell(newNode.rowIndex, 'GROUP'); 
        grid.startEditingCell({ rowIndex: newNode.rowIndex, colKey: 'GROUP' });
      }, 50);
    }
  }
  grid.setGridOption('loading', false);
};
