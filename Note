<template>
  <div class="panel mb-0">
    <div class="panel-heading border-bottom h-50px" style="background-color: var(--bg07)">
      <span class="fs-2 fw-bold" style="color: var(--basic02)">{{ $t('ReleasedNote_vue.title') }}</span>
    </div>

    <div v-if="userInfo.IsDeveloper" class="h-35px p-0 m-0" style="background-color: var(--bg11); padding: 8px 8px 6px">
      <input id="selectedFile" class="d-none" type="file" accept=".xlsx, .xls" @change="handleFileUpload($event)" ref="fileInput" />
      
      <button v-if="isEditMode" class="btn btn-xs btn-success float-end shadow-none me-2 mt-1" @click="saveSecondSheet">
        저장 및 종료
      </button>

      <button class="btn btn-xs btn-gray float-end shadow-none me-2 mt-1" @click="importExcel">
        {{ $t('ReleasedNote_vue.import') }}
      </button>
      
      <button class="btn btn-xs btn-warning float-end shadow-none me-2 mt-1" @click="toggleEditMode">
        {{ isEditMode ? '편집 취소' : '버전 편집' }}
      </button>

      <button class="btn btn-xs btn-primary float-end shadow-none me-2 mt-1" @click="ExportExcel">
        버전다운
      </button>
    </div>

    <div class="panel-body py-2 overflow-auto" style="height: calc(100vh - 150px); background-color: var(--bg14)">
      
      <div v-if="isEditMode" class="p-3">
        <h5 class="text-white mb-3"><i class="fa fa-edit me-2"></i>두 번째 시트 편집 중</h5>
        <div class="excel-grid-wrapper">
          <table class="excel-grid-table">
            <thead>
              <tr>
                <th v-for="header in editHeaders" :key="header">{{ header }}</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(row, rowIndex) in editRows" :key="rowIndex">
                <td v-for="header in editHeaders" :key="header" contenteditable="true" @blur="updateCell($event, rowIndex, header)">
                  {{ row[header] }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div v-else class="pt-2 ps-3">
        <template v-if="releaseNotesGrouped.length > 0">
          <div v-for="(versionGroup, groupIndex) in releaseNotesGrouped" :key="groupIndex">
            <span class="fs-3" style="color: var(--txt04)">{{ $t('ReleasedNote_vue.version') }}</span>
            <span class="fs-3 ms-1" style="color: var(--txt04)">{{ versionGroup.version }}</span>
            <span class="fs-5 ps-2" style="color: var(--txt02)">{{ $t('ReleasedNote_vue.update') }}...</span>
            <ul class="pt-2">
              <li v-for="(item, itemIndex) in versionGroup.items" :key="itemIndex">
                <div class="fs-13px">
                  <div class="h-auto mb-1 pt-1 text-white" :class="getBadgeClass(item.category)">{{ item.category }}</div>
                  <div class="border rounded-3 mb-1" :class="getBadgeTextColorClass(item.category) + ' description-text me-2'" style="background-color: var(--basic02)">
                    <div class="p-1 pb-0">[{{ item.AutoNo }}] : [{{ item.status }}]</div>
                    <div class="p-2 pb-1 fw-normal" style="color: var(--txt03)">{{ item.description }}</div>
                  </div>
                  <div class="border rounded-3 text-cyan-700 mb-1 me-2" style="background-color: var(--basic02)">
                    <div class="p-1 pb-0">{{ $t('ReleasedNote_vue.act_desc') }}</div>
                    <div class="p-2 pb-1 fw-normal" style="color: var(--txt03)">: {{ item.actionDesc }}</div>
                  </div>
                </div>
              </li>
            </ul>
            <hr v-if="Number(groupIndex) < releaseNotesGrouped.length - 1" />
          </div>
        </template>
        <template v-else>
          <p v-if="isLoading" class="text-white">{{ $t('ReleasedNote_vue.load_desc') }}</p>
          <p v-else class="text-white">{{ $t('ReleasedNote_vue.empt_desc') }}</p>
        </template>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRoute } from 'vue-router'
import { useAppAuthenticationStore } from '@/stores/app-authentication'
import { axiosWrapper } from '@/utils/axios/axios-wrapper'
import * as XLSX from 'xlsx'
import { ApiCommon } from '@/utils/axios/api-common'
import * as SEF from '@/utils/spread/spread-excel-funtions.js'

const route = useRoute()
const appAuthentication = useAppAuthenticationStore()
const { userInfo } = appAuthentication

const releaseNotesGrouped: any = ref([])
const isLoading = ref(true)
const fileId: any = ref(null)
const fileInput: any = ref(null)

// 편집 모드 관련 변수
const isEditMode = ref(false)
const editRows: any = ref([])
const editHeaders: any = ref([])
let fullWorkbook: any = null // 원본 워크북 전체 보관 (시트 교체용)

const urlList = {
  gfi: '/api/File/Get',
  gfr: '/api/File/Replace',
}

onMounted(() => {
  const base = import.meta.env.VITE_BASE_SITENAME
  if (base == 'dev') fileId.value = '69827ed36514d58f04e067e7'
  else if (base == 'devop') fileId.value = '698963e8ed2aff6e2771b20d'
  else fileId.value = '6982ac8ea605319e04771832'
  fetchAndParseExcel()
})

/** 편집 모드 토글 및 두 번째 시트 로드 */
const toggleEditMode = async () => {
  if (!isEditMode.value) {
    // 편집 시작 시 데이터 다시 로드 (최신 상태 보장)
    await loadSecondSheetOnly()
  } else {
    isEditMode.value = false
  }
}

/** 엑셀의 두 번째 시트만 로드하는 함수 */
const loadSecondSheetOnly = async () => {
  try {
    SEF.onShowOverlay()
    const options = { responseType: 'blob', headers: { FileToken: 'frontserver@sh' } }
    const res = await axiosWrapper.postAll(urlList.gfi, { id: fileId.value }, options)
    const file = new File([res.data], "temp.xlsx")
    
    ApiCommon.postFileDecryptFile({ FILE: file }).then(async (blob: any) => {
      const data = await blob.arrayBuffer()
      fullWorkbook = XLSX.read(data, { type: 'array' })
      
      // 두 번째 시트 확인 (index 1)
      const sheetName = fullWorkbook.SheetNames[1]
      if (!sheetName) {
        SEF.setToast("두 번째 시트가 존재하지 않습니다.", "err")
        return
      }

      const sheetData: any = XLSX.utils.sheet_to_json(fullWorkbook.Sheets[sheetName], { defval: '' })
      editRows.value = sheetData
      if (sheetData.length > 0) editHeaders.value = Object.keys(sheetData[0])
      
      isEditMode.value = true
    })
  } catch (e) { console.error(e) }
  finally { SEF.onHideOverlay() }
}

/** 셀 수정 반영 */
const updateCell = (e, idx, header) => {
  editRows.value[idx][header] = e.target.innerText
}

/** 수정된 데이터 저장 (두 번째 시트만 교체) */
const saveSecondSheet = async () => {
  try {
    SEF.onShowOverlay()
    
    // 1. 수정된 JSON을 다시 시트로 변환
    const newSheet = XLSX.utils.json_to_sheet(editRows.value)
    
    // 2. 보관 중인 전체 워크북에서 두 번째 시트만 교체
    const secondSheetName = fullWorkbook.SheetNames[1]
    fullWorkbook.Sheets[secondSheetName] = newSheet

    // 3. 다시 파일(Blob)로 만들기
    const excelBuffer = XLSX.write(fullWorkbook, { bookType: 'xlsx', type: 'array' })
    const file = new File([new Blob([excelBuffer])], "Updated_ReleaseNote.xlsx")

    const params = { id: fileId.value, File: file }
    const options = { headers: { 'Content-Type': 'multipart/form-data', FileToken: 'frontserver@sh' } }

    await axiosWrapper.post(urlList.gfr, params, options)
    SEF.setToast("편집 내용이 저장되었습니다.", "info")
    
    isEditMode.value = false
    fetchAndParseExcel() // 목록 새로고침
  } catch (err) {
    SEF.logMng("저장 오류", err, 'err')
  } finally { SEF.onHideOverlay() }
}

/** 기존 목록 조회 로직 (원복된 상태 유지) */
const fetchAndParseExcel = async function () {
  isLoading.value = true
  try {
    const options = { responseType: 'blob', headers: { FileToken: 'frontserver@sh' } }
    await axiosWrapper.postAll(urlList.gfi, { id: fileId.value }, options).then((blobData: any) => {
      const file = new File([blobData.data], "temp.xlsx")
      ApiCommon.postFileDecryptFile({ FILE: file }).then(async (blob: any) => {
        const data = await blob.arrayBuffer()
        const workbook = XLSX.read(data, { type: 'array' })
        const s1 = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: '' })
        const s2 = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[1]], { defval: '' })
        
        let combined = (s1.length > 0) ? [...s1] : []
        if (s2.length > 0) combined = [...s1, ...s2]
        else if (combined.length > 0) combined.shift()

        const filtered = combined.filter((row: any) => {
          const status = (row['STATUS'] || row['__EMPTY_16'] || '').toString().toUpperCase()
          return ['FINISH', 'CHECKED', 'READY'].includes(status) && (row['완료 버젼'] || row['__EMPTY_18'])
        })

        const grouped: any = {}
        filtered.forEach((row: any) => {
          const ver = (row['완료 버젼'] || row['__EMPTY_18']).toString().toLowerCase()
          if (!grouped[ver]) grouped[ver] = { version: ver, items: [] }
          grouped[ver].items.push({
            AutoNo: row['Auto No'] || row['__EMPTY_4'] || '',
            category: (row['구분'] || row['__EMPTY_9'] || 'unknown').toLowerCase(),
            description: row['기능 요청 상세 내용'] || row['__EMPTY_10'],
            actionDesc: row['ACTION 부서 회신 내용'] || row['__EMPTY_11'],
            status: row['STATUS'] || row['__EMPTY_16']
          })
        })
        releaseNotesGrouped.value = Object.values(grouped).sort((a:any, b:any) => b.version.localeCompare(a.version))
      })
    })
  } catch (e) { console.error(e) }
  finally { isLoading.value = false; SEF.onHideOverlay() }
}

const ExportExcel = async function () { /* 기존 다운로드 로직 */ }
const importExcel = () => fileInput.value.click()
const handleFileUpload = async (e) => { /* 기존 업로드 로직 */ }
const getBadgeClass = (c) => ['오류','fixed'].includes(c) ? 'badge bg-gradient-orange-red' : 'badge bg-gradient-teal-green'
const getBadgeTextColorClass = (c) => ['오류','fixed'].includes(c) ? 'text-danger' : 'text-success'
</script>

<style scoped>
.excel-grid-wrapper { width: 100%; overflow: auto; background: #fff; border-radius: 4px; border: 1px solid #444; }
.excel-grid-table { border-collapse: collapse; width: max-content; min-width: 100%; font-size: 12px; }
.excel-grid-table th { background: #333; color: #eee; border: 1px solid #555; padding: 10px; position: sticky; top: 0; }
.excel-grid-table td { border: 1px solid #ddd; padding: 8px; min-width: 120px; max-width: 350px; outline: none; white-space: pre-wrap; color: #333; background: #fff; }
.excel-grid-table td:focus { background: #fff9c4; border: 2px solid #fbc02d; }
.badge { border-radius: 20px; display: inline-block; width: 80px; height: 30px; line-height: 20px; text-align: center; padding-top: 5px; font-weight: 700; }
ul { list-style: none; padding-left: 0; }
li { margin: 8px 0; }
</style>
